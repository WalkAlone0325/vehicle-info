"use strict";const e=require("../../common/vendor.js"),C=require("../../utils/index.js");require("../../utils/request.js");const p=require("../../api/order.js"),z=require("../../api/common.js"),x=require("../../hooks/useColPickerData.js");if(!Array){const I=e.resolveComponent("wd-message-box"),u=e.resolveComponent("wd-toast"),s=e.resolveComponent("wd-input"),c=e.resolveComponent("wd-picker"),_=e.resolveComponent("wd-col-picker"),g=e.resolveComponent("wd-datetime-picker"),a=e.resolveComponent("wd-textarea"),h=e.resolveComponent("wd-cell-group"),r=e.resolveComponent("wd-button"),f=e.resolveComponent("wd-form"),v=e.resolveComponent("wd-select-picker"),m=e.resolveComponent("BaseForm");(I+u+s+c+_+g+a+h+r+f+v+m)()}const G=()=>"../../uni_modules/wot-design-uni/components/wd-message-box/wd-message-box.js",H=()=>"../../uni_modules/wot-design-uni/components/wd-toast/wd-toast.js",J=()=>"../../uni_modules/wot-design-uni/components/wd-input/wd-input.js",K=()=>"../../uni_modules/wot-design-uni/components/wd-picker/wd-picker.js",Q=()=>"../../uni_modules/wot-design-uni/components/wd-col-picker/wd-col-picker.js",W=()=>"../../uni_modules/wot-design-uni/components/wd-datetime-picker/wd-datetime-picker.js",X=()=>"../../uni_modules/wot-design-uni/components/wd-textarea/wd-textarea.js",Z=()=>"../../uni_modules/wot-design-uni/components/wd-cell-group/wd-cell-group.js",ee=()=>"../../uni_modules/wot-design-uni/components/wd-button/wd-button.js",ae=()=>"../../uni_modules/wot-design-uni/components/wd-form/wd-form.js",te=()=>"../../uni_modules/wot-design-uni/components/wd-select-picker/wd-select-picker.js",oe=()=>"../../components/BaseForm.js";Math||(G+H+J+K+Q+W+X+Z+ee+ae+te+oe)();const le={__name:"form",setup(I){const u=e.ref(""),s=e.ref(Date.now()),c=e.ref(""),_=e.ref(null),g=e.ref(null),a=e.ref({applicantNickName:"",applicantUserId:"",applicantUserName:"",applicantDeptId:"",applicantDeptName:"",applicantCompanyDeptId:"",applicantCompanyDeptName:"",applicantPostId:"",applicantStartRegionCode:"",name1:"",name2:"",code1:[],code2:[],applicantEndRegionCode:"",applicantIsIntermarketCityCode:"",applicantPassengersNumber:"",planStartTime:"",planEndTime:"",applicantContent:""}),h=e.ref({applicantContent:[{required:!0,message:"请输入申请内容"}],planStartTime:[{required:!0,message:"请选择用车开始时间"}],planEndTime:[{required:!0,message:"请选择用车结束时间"}],applicantPassengersNumber:[{required:!0,message:"请输入乘车人数"}],applicantStartRegionCode:[{required:!0,message:"请选择开始地点"}],applicantEndRegionCode:[{required:!0,message:"请选择目标地点"}],applicantIsIntermarketCityCode:[{required:!0,message:"请选择是否跨市"}]}),r=e.ref({approvalCause:void 0,approvalResultCode:void 0,approveDriverId:void 0,approveDriverName:void 0,approvePlateNumber:void 0,approveDriverMobile:void 0,approveVehicleId:void 0,useCarApplicationOrderId:void 0}),f=e.ref({approvalCause:[{required:!0,message:"请输入审批原因"}]});e.ref([]);const v=e.ref([]),m=e.ref([]),T=()=>{_.value.validate().then(async({valid:t,errors:l})=>{t&&(a.value.useCarApplicationOrderId?(await p.putOrderDraftApi({...a.value,planStartTime:C.formatDate(a.value.planStartTime),planEndTime:C.formatDate(a.value.planEndTime),orderStatusCode:"pending"})).code===200&&(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout(()=>{e.index.navigateBack()},1e3)):(await p.postOrderApplyApi({...a.value,planStartTime:C.formatDate(a.value.planStartTime),planEndTime:C.formatDate(a.value.planEndTime),orderStatusCode:"pending"})).code===200&&(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout(()=>{e.index.navigateBack()},1e3)))}).catch(t=>{e.index.__f__("log","at pages/order/form.vue:125",t,"error")})},d=e.computed(()=>!(u.value!=="history"&&u.value!=="approve")),V=async()=>{const t=await p.getApplyInfoApi();a.value.applicantNickName=t.data.nickName,a.value.applicantUserId=t.data.userId,a.value.applicantDeptId=t.data.deptId,a.value.applicantCompanyDeptId=t.data.companyDeptId,a.value.applicantPostId=t.data.postId,a.value.applicantUserName=t.data.username,a.value.applicantDeptName=t.data.deptName,a.value.applicantCompanyDeptName=t.data.companyDeptName};e.ref([]);const B=e.ref([]),S=async(t,l)=>{const o=await z.getDictApi(t);l.value=o.data},y=e.ref([[]]),w=e.ref([[]]),b=e.ref([]),P=async t=>{const l=await p.getRegionApi(t);y.value[0]=l.data,w.value[0]=l.data,b.value=l.data},R=async({selectedItem:t,index:l,resolve:o,finish:n})=>{if(l<2){const F=await p.getRegionApi({code:t.code}),i=x.findChildrenByCode(y.value[l],t.code,F.data);l==0&&(y.value=[b.value]),i&&i.length?(y.value[l+1]=i,o(i)):n()}else n()},q=async({selectedItem:t,index:l,resolve:o,finish:n})=>{if(l<2){const F=await p.getRegionApi({code:t.code}),i=x.findChildrenByCode(w.value[l],t.code,F.data);l==0&&(w.value=[b.value]),i&&i.length?(w.value[l+1]=i,o(i)):n()}else n()},k=({value:t,selectedItems:l})=>{a.value.code1=t,a.value.applicantStartRegionCode=t[2]},D=({value:t,selectedItems:l})=>{a.value.code2=t,a.value.applicantEndRegionCode=t[2]};e.watchEffect(()=>{var o,n;if(!a.value.applicantStartRegionCode||!a.value.applicantEndRegionCode){a.value.applicantIsIntermarketCityCode="";return}const t=(o=a.value.applicantStartRegionCode)==null?void 0:o.substring(0,4),l=(n=a.value.applicantEndRegionCode)==null?void 0:n.substring(0,4);a.value.applicantIsIntermarketCityCode=t===l?"N":"Y"});const E=e.ref([]),j=async()=>{const t=await p.getPostApi();E.value=t.data,t.data.length&&(a.value.applicantPostId=t.data[0].postId)},O=async t=>{const l=await p.getOrderDetailApi(t);a.value={...l.data,code1:[l.data.applicantStartProvinceCode,l.data.applicantStartCityCode,l.data.applicantStartCountyCode],code2:[l.data.applicantEndProvinceCode,l.data.applicantEndCityCode,l.data.applicantEndCountyCode]},r.value={...r.value,approveDriverId:a.value.approveDriverId,approveVehicleId:a.value.approveVehicleId,approveDriverMobile:a.value.approveDriverMobile,approvalCause:a.value.approvalCause},k({value:a.value.code1}),D({value:a.value.code2})},N=t=>{s.value=a.value[t===1?"planStartTime":"planEndTime"]||Date.now()};e.onMounted(()=>{V(),j(),S("sys_yes_no",B)}),e.onLoad(async t=>{try{e.index.showLoading({title:"加载中..."}),u.value=t.type,c.value=t.id,await P(),c.value&&(await O(c.value),(u.value==="approve"||u.value==="history")&&(await U(),await L())),e.index.hideLoading()}catch{e.index.hideLoading()}});const $=({value:t})=>{const l=m.value.find(o=>o.driverId===t);r.value.approveDriverName=l.driverName},M=({value:t})=>{const l=v.value.find(o=>o.vehicleId===t);r.value.approvePlateNumber=l.plateNumber,r.value.approveDriverName=l.driverName,r.value.approveDriverId=l.driverId},A=t=>{g.value.validate().then(async({valid:l,errors:o})=>{if(l){if(a.value.taskName==="车辆管理员"){if(!r.value.approveVehicleId){e.index.showToast({title:"请选择车辆",icon:"none"});return}if(!r.value.approveDriverId){e.index.showToast({title:"请选择司机",icon:"none"});return}}(await p.postApprove({...r.value,approvalResultCode:t,taskId:a.value.taskId,taskName:a.value.taskName,useCarApplicationOrderId:a.value.useCarApplicationOrderId})).code===200&&(e.index.showToast({title:"审批成功",icon:"success"}),setTimeout(()=>{e.index.navigateBack()},1e3))}}).catch(l=>{e.index.__f__("log","at pages/order/form.vue:325",l,"error")})},U=async()=>{const t=await p.getCarApi({isIncludeCompany:"N",deptId:a.value.applicantCompanyDeptId});v.value=t.rows.map(l=>({...l,label:`${l.plateNumber}（${l.brandModel}）${l.vehicleTypeName}`}))},L=async()=>{const t=await p.getDriverApi({isIncludeCompany:"N",deptId:a.value.applicantCompanyDeptId});m.value=t.rows.map(l=>({...l,label:`${l.driverName}（${l.driverSexName}）${l.licenseTypeName}`}))},Y=t=>{e.index.previewImage({urls:[`data:image/jpg;base64,${a.value.flowChart}`]})};return(t,l)=>e.e({a:e.o(o=>a.value.applicantNickName=o),b:e.p({label:"申请人","label-width":"100px",prop:"applicantNickName",clearable:!0,placeholder:"请输入申请人",readonly:!0,modelValue:a.value.applicantNickName}),c:e.o(o=>a.value.applicantUserName=o),d:e.p({label:"申请人账号","label-width":"100px",prop:"applicantUserId",clearable:!0,placeholder:"请输入申请人账号",readonly:!0,modelValue:a.value.applicantUserName}),e:e.o(o=>a.value.applicantCompanyDeptName=o),f:e.p({label:"申请人公司","label-width":"100px",prop:"applicantDeptId",clearable:!0,placeholder:"请输入申请人公司",readonly:!0,modelValue:a.value.applicantCompanyDeptName}),g:e.o(o=>a.value.applicantDeptName=o),h:e.p({label:"申请人部门","label-width":"100px",prop:"applicantCompanyDeptId",clearable:!0,placeholder:"请输入申请人部门",readonly:!0,modelValue:a.value.applicantDeptName}),i:e.o(o=>a.value.applicantPostId=o),j:e.p({readonly:d.value,label:"申请人岗位",placeholder:"请选择申请人岗位","value-key":"postId","label-key":"postName","label-width":"100px",prop:"applicantPostId",columns:E.value,modelValue:a.value.applicantPostId}),k:e.o(k),l:e.o(o=>a.value.code1=o),m:e.p({clearable:!0,"auto-complete":!0,"label-width":"100px",label:"开始地点",prop:"applicantStartRegionCode",columns:y.value,"column-change":R,readonly:d.value,"value-key":"code","label-key":"name",modelValue:a.value.code1}),n:e.o(D),o:e.o(o=>a.value.code2=o),p:e.p({clearable:!0,"auto-complete":!0,"label-width":"100px",label:"目标地点",prop:"applicantEndRegionCode",columns:w.value,"column-change":q,readonly:d.value,"value-key":"code","label-key":"name",modelValue:a.value.code2}),q:e.o(o=>a.value.applicantIsIntermarketCityCode=o),r:e.p({readonly:d.value,label:"是否跨市",placeholder:"请选择是否跨市","value-key":"dictValue","label-key":"dictLabel","label-width":"100px",prop:"applicantIsIntermarketCityCode",columns:B.value,modelValue:a.value.applicantIsIntermarketCityCode}),s:e.o(o=>a.value.applicantPassengersNumber=o),t:e.p({label:"乘车人数",type:"number",readonly:d.value,"label-width":"100px",prop:"applicantPassengersNumber",clearable:!0,placeholder:"请输入乘车人数",modelValue:a.value.applicantPassengersNumber}),v:e.o(N),w:e.o(o=>a.value.planStartTime=o),x:e.p({readonly:d.value,"default-value":s.value,label:"计划开始时间","label-width":"100px",placeholder:"请选择时间",prop:"planStartTime",modelValue:a.value.planStartTime}),y:e.o(o=>N(2)),z:e.o(o=>a.value.planEndTime=o),A:e.p({readonly:d.value,"default-value":s.value,label:"计划结束时间","label-width":"100px",placeholder:"请选择时间",prop:"planEndTime",modelValue:a.value.planEndTime}),B:e.o(o=>a.value.applicantContent=o),C:e.p({readonly:d.value,label:"申请内容","label-width":"100px",prop:"applicantContent",clearable:!0,placeholder:"请输入申请内容",maxlength:200,"auto-height":!0,"show-word-limit":!0,type:"textarea",modelValue:a.value.applicantContent}),D:e.p({title:"基础信息",border:!0}),E:u.value==="draft"||!u.value},u.value==="draft"||!u.value?{F:e.o(T),G:e.p({type:"primary"})}:{},{H:e.sr(_,"efa79250-3,efa79250-2",{k:"form"}),I:e.p({model:a.value,rules:h.value,errorType:"toast"}),J:u.value==="approve"||u.value==="history"},u.value==="approve"||u.value==="history"?e.e({K:e.o(Y),L:a.value.taskName},a.value.taskName?{M:e.o(o=>a.value.taskName=o),N:e.p({label:"任务节点","label-width":"80px",prop:"taskName",clearable:!0,placeholder:"请输入任务节点",readonly:!0,modelValue:a.value.taskName})}:{},{O:e.o(M),P:e.o(o=>r.value.approveVehicleId=o),Q:e.p({clearable:!0,readonly:u.value==="history",type:"radio","value-key":"vehicleId","label-key":"label","label-width":"80px",prop:"approveVehicleId",label:"派发车辆",placeholder:"请选择派发车辆",columns:v.value,filterable:!0,"show-confirm":!1,modelValue:r.value.approveVehicleId}),R:e.o($),S:e.o(o=>r.value.approveDriverId=o),T:e.p({clearable:!0,readonly:u.value==="history",type:"radio","value-key":"driverId","label-key":"label","label-width":"80px",prop:"approveDriverId",label:"车辆司机",placeholder:"请选择车辆司机",columns:m.value,filterable:!0,"show-confirm":!1,modelValue:r.value.approveDriverId}),U:u.value!=="history"},u.value!=="history"?{V:e.o(o=>r.value.approvalCause=o),W:e.p({readonly:u.value==="history",label:"审批原因","label-width":"80px",prop:"approvalCause",clearable:!0,placeholder:"请输入审批原因",maxlength:200,"auto-height":!0,"show-word-limit":!0,type:"textarea",modelValue:r.value.approvalCause})}:{},{X:u.value==="history"},u.value==="history"?{Y:e.o(o=>a.value.orderStatusName=o),Z:e.p({label:"审核状态",readonly:!0,"label-width":"80px",prop:"orderStatusName",clearable:!0,placeholder:"",modelValue:a.value.orderStatusName})}:{},{aa:e.p({title:"审批信息",border:!0,"use-slot":!0}),ab:u.value==="approve"},u.value==="approve"?{ac:e.o(o=>A("pass")),ad:e.p({type:"warning"}),ae:e.o(o=>A("refuse")),af:e.p({type:"primary"})}:{}):{},{ag:e.sr(g,"efa79250-18,efa79250-2",{k:"approveForm"}),ah:e.p({model:r.value,rules:f.value,errorType:"toast"}),ai:e.p({group:!0})})}},ue=e._export_sfc(le,[["__scopeId","data-v-efa79250"]]);wx.createPage(ue);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/order/form.js.map

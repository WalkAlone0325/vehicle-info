"use strict";const s=require("../../../../common/vendor.js"),l=require("../common/util.js"),Z=require("../composables/useTranslate.js"),ee=require("../composables/useUpload.js"),oe=require("./types.js");Math||(se+te+ne)();const se=()=>"../wd-icon/wd-icon.js",ne=()=>"../wd-video-preview/wd-video-preview.js",te=()=>"../wd-loading/wd-loading.js",ie={name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"}},ue=s.defineComponent({...ie,props:oe.uploadProps,emits:["fail","change","success","progress","oversize","chooseerror","remove","update:fileList"],setup(k,{expose:N,emit:R}){const i=k,m=R;N({submit:()=>T(),abort:()=>H()});const{translate:A}=Z.useTranslate("upload"),a=s.ref([]),C=s.computed(()=>!i.limit||a.value.length<i.limit),G=s.ref(),{startUpload:U,abort:H,chooseFile:B,UPLOAD_STATUS:J}=ee.useUpload();s.watch(()=>i.fileList,e=>{const{statusKey:t}=i;if(l.isEqual(e,a.value))return;const o=e.map(n=>(n[t]=n[t]||"success",n.response=n.response||"",{...n,uid:l.context.id++}));a.value=o},{deep:!0,immediate:!0}),s.watch(()=>i.limit,e=>{e&&e<a.value.length&&s.index.__f__("error","at uni_modules/wot-design-uni/components/wd-upload/wd-upload.vue:172","[wot-design]Error: props limit must less than fileList.length")},{deep:!0,immediate:!0}),s.watch(()=>i.beforePreview,e=>{e&&!l.isFunction(e)&&s.index.__f__("error","at uni_modules/wot-design-uni/components/wd-upload/wd-upload.vue:185","The type of beforePreview must be Function")},{deep:!0,immediate:!0}),s.watch(()=>i.onPreviewFail,e=>{e&&!l.isFunction(e)&&s.index.__f__("error","at uni_modules/wot-design-uni/components/wd-upload/wd-upload.vue:198","The type of onPreviewFail must be Function")},{deep:!0,immediate:!0}),s.watch(()=>i.beforeRemove,e=>{e&&!l.isFunction(e)&&s.index.__f__("error","at uni_modules/wot-design-uni/components/wd-upload/wd-upload.vue:211","The type of beforeRemove must be Function")},{deep:!0,immediate:!0}),s.watch(()=>i.beforeUpload,e=>{e&&!l.isFunction(e)&&s.index.__f__("error","at uni_modules/wot-design-uni/components/wd-upload/wd-upload.vue:224","The type of beforeUpload must be Function")},{deep:!0,immediate:!0}),s.watch(()=>i.beforeChoose,e=>{e&&!l.isFunction(e)&&s.index.__f__("error","at uni_modules/wot-design-uni/components/wd-upload/wd-upload.vue:237","The type of beforeChoose must be Function")},{deep:!0,immediate:!0}),s.watch(()=>i.buildFormData,e=>{e&&!l.isFunction(e)&&s.index.__f__("error","at uni_modules/wot-design-uni/components/wd-upload/wd-upload.vue:250","The type of buildFormData must be Function")},{deep:!0,immediate:!0});function y(){m("update:fileList",a.value)}function T(){const{buildFormData:e,formData:t={},statusKey:o}=i,{action:n,name:u,header:r={},accept:c,successStatus:d,uploadMethod:h}=i,g=l.isDef(d)?d:200;for(const p of a.value)p[o]===J.PENDING&&(e?e({file:p,formData:t,resolve:_=>{_&&U(p,{action:n,header:r,name:u,formData:_,fileType:c,statusCode:g,statusKey:o,uploadMethod:h,onSuccess:K,onError:D,onProgress:z})}}):U(p,{action:n,header:r,name:u,formData:t,fileType:c,statusCode:g,statusKey:o,uploadMethod:h,onSuccess:K,onError:D,onProgress:z}))}function O(e){return new Promise((t,o)=>{s.index.getImageInfo({src:e,success:n=>{t(n)},fail:n=>{o(n)}})})}function Q(e,t){const{statusKey:o}=i,n={uid:l.context.id++,name:e.name||"",thumb:e.thumb||"",[o]:"pending",size:e.size||0,url:e.path,percent:0};typeof t=="number"?a.value.splice(t,1,n):a.value.push(n),i.autoUpload&&T()}function D(e,t,o){const{statusKey:n}=i,u=a.value.findIndex(r=>r.uid===t.uid);u>-1&&(a.value[u][n]="fail",a.value[u].error=e.message,a.value[u].response=e,m("fail",{error:e,file:t,formData:o}),y())}function K(e,t,o){const{statusKey:n}=i,u=a.value.findIndex(r=>r.uid===t.uid);u>-1&&(a.value[u][n]="success",a.value[u].response=e.data,m("change",{fileList:a.value}),m("success",{file:t,fileList:a.value,formData:o}),y())}function z(e,t){const o=a.value.findIndex(n=>n.uid===t.uid);o>-1&&(a.value[o].percent=e.progress,m("progress",{response:e,file:t}))}function x(e){const{multiple:t,maxSize:o,accept:n,sizeType:u,limit:r,sourceType:c,compressed:d,maxDuration:h,camera:g,beforeUpload:p,extension:_}=i;B({multiple:t,sizeType:u,sourceType:c,maxCount:r?r-a.value.length:9,accept:n,compressed:d,maxDuration:h,camera:g,extension:_}).then(P=>{let w=P;t||(w=w.slice(0,1));const V=async b=>{for(let L=0;L<b.length;L++){const v=b[L];if(v.type==="image"&&!v.size){const j=await O(v.path);v.size=j.width*j.height}Number(v.size)<=o?Q(v,e):m("oversize",{file:v})}};p?p({files:w,fileList:a.value,resolve:b=>{b&&V(w)}}):V(w)}).catch(P=>{m("chooseerror",{error:P})})}function f(e){if(i.disabled)return;const{beforeChoose:t}=i;t?t({fileList:a.value,resolve:o=>{o&&x(e)}}):x(e)}function S(e){a.value.splice(a.value.findIndex(t=>t.uid===e.uid),1),m("change",{fileList:a.value}),m("remove",{file:e}),y()}function W(e){const{beforeRemove:t}=i,o=e,n=a.value[o];t?t({file:n,index:o,fileList:a.value,resolve:u=>{u&&S(n)}}):S(n)}function E(e){s.index.openDocument({filePath:e.url,showMenu:!0})}function $(e,t){const{onPreviewFail:o}=i;s.index.previewImage({urls:t,current:t[e],fail(){o?o({index:e,imgList:t}):s.index.showToast({title:"预览图片失败",icon:"none"})}})}function q(e,t){const{onPreviewFail:o}=i;s.index.previewMedia({current:e,sources:t.map(n=>({url:n.url,type:"video",poster:n.thumb})),fail(){o?o({index:e,imgList:[]}):s.index.showToast({title:"预览视频失败",icon:"none"})}})}function X(e){const{beforePreview:t,reupload:o}=i,n=l.deepClone(a.value),u=n.findIndex(d=>d.url===e.url),r=n.filter(d=>I(d)).map(d=>d.url),c=r.findIndex(d=>d===e.url);o?f(u):t?t({file:e,index:u,fileList:n,imgList:r,resolve:d=>{d&&$(c,r)}}):$(c,r)}function M(e){const{beforePreview:t,reupload:o}=i,n=l.deepClone(a.value),u=n.findIndex(d=>d.url===e.url),r=n.filter(d=>F(d)),c=r.findIndex(d=>d.url===e.url);o?f(u):t?t({file:e,index:u,imgList:[],fileList:n,resolve:d=>{d&&q(c,r)}}):q(c,r)}function Y(e){const{beforePreview:t,reupload:o}=i,n=l.deepClone(a.value),u=n.findIndex(r=>r.url===e.url);o?f(u):t?t({file:e,index:u,imgList:[],fileList:n,resolve:r=>{r&&E(e)}}):E(e)}function F(e){return e.name&&l.isVideoUrl(e.name)||l.isVideoUrl(e.url)}function I(e){return e.name&&l.isImageUrl(e.name)||l.isImageUrl(e.url)}return(e,t)=>s.e({a:s.f(a.value,(o,n,u)=>s.e({a:I(o)},I(o)?{b:o.url,c:e.imageMode,d:s.o(r=>X(o),n)}:F(o)?s.e({f:o.thumb},o.thumb?{g:o.thumb,h:e.imageMode,i:"d50d9cde-0-"+u,j:s.p({name:"play-circle-filled","custom-class":"wd-upload__video-paly"}),k:s.o(r=>M(o),n)}:{l:o.url,m:o.name||"视频"+n,n:o.thumb,o:"d50d9cde-1-"+u,p:s.p({name:"play-circle-filled","custom-class":"wd-upload__video-paly"}),q:s.o(r=>M(o),n)}):{r:"d50d9cde-2-"+u,s:s.p({name:"file","custom-class":"wd-upload__file-icon"}),t:s.t(o.name||o.url),v:s.o(r=>Y(o),n)},{e:F(o),w:o[i.statusKey]!=="success"},o[i.statusKey]!=="success"?s.e({x:o[i.statusKey]==="loading"},o[i.statusKey]==="loading"?{y:"d50d9cde-3-"+u,z:s.p({type:e.loadingType,size:e.loadingSize,color:e.loadingColor}),A:s.t(o.percent)}:{},{B:o[i.statusKey]==="fail"},o[i.statusKey]==="fail"?{C:"d50d9cde-4-"+u,D:s.p({name:"close-outline","custom-class":"wd-upload__icon"}),E:s.t(o.error||s.unref(A)("error"))}:{}):{},{F:o[i.statusKey]!=="loading"&&!e.disabled},o[i.statusKey]!=="loading"&&!e.disabled?{G:s.o(r=>W(n),n),H:"d50d9cde-5-"+u,I:s.p({name:"error-fill","custom-class":"wd-upload__close"})}:{},e.$slots["preview-cover"]?{J:"preview-cover-"+u,K:s.r("preview-cover",{file:o,index:n},u)}:{},{L:n})),b:e.$slots["preview-cover"],c:s.n(e.customPreviewClass),d:C.value},C.value?s.e({e:e.$slots.default},e.$slots.default?{f:s.n(e.customEvokeClass),g:s.o(f)}:s.e({h:s.p({name:"fill-camera"}),i:e.limit&&e.showLimitNum},e.limit&&e.showLimitNum?{j:s.t(a.value.length),k:s.t(e.limit)}:{},{l:s.o(f),m:s.n(e.disabled?"is-disabled":""),n:s.n(e.customEvokeClass)})):{},{o:s.n(e.customClass),p:s.s(e.customStyle),q:s.sr(G,"d50d9cde-7",{k:"videoPreview"})})}}),ae=s._export_sfc(ue,[["__scopeId","data-v-d50d9cde"]]);wx.createComponent(ae);
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/uni_modules/wot-design-uni/components/wd-upload/wd-upload.js.map

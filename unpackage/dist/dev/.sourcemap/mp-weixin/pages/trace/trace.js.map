{"version":3,"file":"trace.js","sources":["pages/trace/trace.vue","pages/trace/trace.vue?type=page"],"sourcesContent":["<script setup>\nimport { ref } from 'vue'\nimport { getLocationApi, getDeptApi, getTraceApi } from '@/api'\nimport { useQueue } from '@/uni_modules/wot-design-uni'\nimport { onShow } from '@dcloudio/uni-app'\nimport { randomRgbColor, wgs84togcj02, formatDateTime, getTodayTimestampRange } from '@/utils'\n\nconst { closeOutside } = useQueue()\n\nconst curIdx = ref(0)\n\nconst dropRef = ref(null)\nconst dropRef2 = ref(null)\nconst scale = ref(7)\nconst plateNumber = ref()\nconst deptId = ref()\nconst markerList = ref([])\nconst data = ref({})\nconst markers = ref([])\n\nconst getData = async () => {\n  const res = await getLocationApi({\n    deptId: deptId.value,\n    plateNumber: plateNumber.value,\n  })\n  if (deptId.value) {\n    scale.value = 8\n  } else {\n    scale.value = 7\n  }\n  data.value = res.data\n  markerList.value = res.data.carVehicleInfoList.map((i, idx) => ({\n    iconPath: '/static/location.png',\n    latitude: i.latitude,\n    longitude: i.longitude,\n    id: idx + 1,\n    width: 20,\n    height: 20,\n    label: {\n      content: i.plateNumber,\n      borderWidth: 1,\n      borderColor: '#999',\n      bgColor: '#fff',\n      borderRadius: 2,\n      padding: 3\n    }\n  }))\n\n  markers.value = markerList.value\n}\n\nconst handleConfirm = () => {}\n\nconst model = ref({\n  plateNumber: '',\n  date: getTodayTimestampRange()\n})\nconst traceData = ref({})\nconst polyline = ref([]) // 路线\nconst getTraceData = async () => {\n  const res = await getTraceApi({\n    // deptId: deptId.value,\n    plateNumber: model.value.plateNumber,\n    startDate: formatDateTime(model.value.date[0]),\n    endDate: formatDateTime(model.value.date[1])\n  })\n  if(res.code === 200) {\n    traceData.value = res.data\n    polyline.value = res.data.queryRecordLocationListOutBeanList.map((i, idx) => {\n      return {\n        width: 3,\n        arrowLine: true,\n        color: randomRgbColor(),\n        points: handlePoints(i, idx)\n      }\n    })\n\n    markers.value = []\n    markers.value = allStopPoints.value.map((i, idx) => ({\n      iconPath: '/static/stop.png',\n      latitude: i.latitude,\n      longitude: i.longitude,\n      id: idx + 1,\n      width: 20,\n      height: 20,\n      label: {\n        content: getDay(i.time),\n        borderWidth: 1,\n        borderColor: '#999',\n        bgColor: '#fff',\n        borderRadius: 2,\n        padding: 3\n      }\n    }))\n  }\n}\n\nconst getDay = (timestemp) => {\n  const day = Math.floor(timestemp / (24*3600*1000))\n  const hour = Math.floor(timestemp / (3600*1000) % 24)\n  const minute = Math.floor(timestemp / (60*1000) % 60)\n  const second = Math.floor(timestemp / 1000 % 60)\n  const dayStr = day ? `${day}天` : ''\n  const hourStr = hour ? `${hour}时` : ''\n  const minuteStr = minute ? `${minute}分` : ''\n  const secondStr = second ? `${second}秒` : ''\n  return `${dayStr}${hourStr}${minuteStr}${secondStr}`\n}\n\nconst allStopPoints = ref([])\nconst handlePoints = (i, idx) => {\n  const arr = []\n  let setArr = []\n  const res = JSON.parse(i.locations).map(j => {\n    const res = wgs84togcj02(j[0], j[1])\n    arr.push({str: '' + res[0] + res[1], date: j[4], latitude: res[1], longitude: res[0],})\n    return {latitude: res[1], longitude: res[0], str: '' + res[0] + res[1], date: j[4]}\n  })\n  setArr = [...new Set(arr.map(i => i.str))]\n  const start = arr.find(i => i.str == setArr[0])\n  const end = arr.findLast(i => i.str == setArr[0])\n\n  function getTimestemp(date) {\n    return new Date(date.replace(' ', 'T')).getTime()\n  }\n\n  // 大于 5 分钟，停止\n  const time = getTimestemp(end.date) - getTimestemp(start.date)\n  if(time >= 300000) {\n    allStopPoints.value.push({...end, time})\n  }\n\n  return res\n}\n\nconst handleReset = () => {\n  model.value.date = getTodayTimestampRange()\n  model.value.plateNumber = ''\n  search()\n}\n\nconst search = () => {\n  if(curIdx.value === 0) {\n    markerList.value = []\n    data.value = {}\n    markers.value = []\n    getData()\n    dropRef.value.close()\n  } else if(curIdx.value === 1) {\n    markers.value = []\n    traceData.value = {}\n    polyline.value = []\n    allStopPoints.value = []\n    getTraceData()\n    dropRef2.value.close()\n  }\n}\nconst reset = () => {\n  if (!deptId.value && !plateNumber.value) return\n  plateNumber.value = undefined\n  deptId.value = undefined\n  search()\n}\n\nconst deptOptions = ref([])\nconst getDept = async () => {\n  const res = await getDeptApi()\n  deptOptions.value = res.data.filter((i) => i.pId != '0').map((i) => ({\n    label: i.name,\n    value: i.id\n  }))\n}\n\n// 改变drop\nconst clickDrop = (item, idx) => {\n  if(curIdx.value === idx) return\n  curIdx.value = idx\n  plateNumber.value = undefined\n  deptId.value = undefined\n  markerList.value = []\n  data.value = {}\n  markers.value = []\n\n  traceData.value = {}\n  polyline.value = []\n  if(curIdx.value !== 1) {\n    search()\n  }\n}\n\nonShow(() => {\n  getData()\n  getDept()\n})\n</script>\n\n<template>\n  <view class=\"trace-page\">\n    <view @click=\"closeOutside\">\n      <wd-drop-menu @click=\"clickDrop\" :idx=\"curIdx\">\n        <wd-drop-menu-item title=\"车辆位置\" ref=\"dropRef\">\n          <view class=\"drop-con\">\n            <wd-search v-model=\"plateNumber\" placeholder-left cancel-txt=\"重置\" @cancel=\"reset\" placeholder=\"请输入车牌号进行搜索\"\n              @search=\"search\" />\n            <wd-radio-group v-model=\"deptId\" shape=\"button\" @change=\"search\">\n              <view class=\"radio-con\">\n                <view class=\"radio-item\" v-for=\"i in deptOptions\" :key=\"i.value\">\n                  <wd-radio :value=\"i.value\">{{ i.label }}</wd-radio>\n                </view>\n              </view>\n            </wd-radio-group>\n          </view>\n        </wd-drop-menu-item>\n        <wd-drop-menu-item title=\"车辆轨迹\" ref=\"dropRef2\">\n          <view class=\"drop-con\">\n            <wd-form ref=\"form\" :model=\"model\">\n              <wd-cell-group border>\n                <wd-input\n                  label=\"车牌号\"\n                  label-width=\"80px\"\n                  prop=\"plateNumber\"\n                  clearable\n                  v-model=\"model.plateNumber\"\n                  placeholder=\"请输入车牌号进行查询\"\n                />\n                <wd-datetime-picker prop=\"date\" label-width=\"80px\" label=\"日期选择\" placeholder=\"请选择日期\" v-model=\"model.date\" @confirm=\"handleConfirm\" />\n              </wd-cell-group>\n              <view style=\"display: flex;justify-content: center; padding: 20rpx 30rpx;\">\n                <wd-button type=\"primary\" @click=\"search\">搜索</wd-button>\n                <view style=\"margin-right: 30rpx;\"></view>\n                <wd-button type=\"warning\" @click=\"handleReset\">重置</wd-button>\n              </view>\n            </wd-form>\n          </view>\n        </wd-drop-menu-item>\n      </wd-drop-menu>\n    </view>\n    <map id=\"map\" :polyline=\"polyline\" :scale=\"scale\" :longitude=\"data.longitude\" :latitude=\"data.latitude\" :markers=\"markers\"></map>\n  </view>\n</template>\n\n<style scoped lang=\"scss\">\n.trace-page,\nmap {\n  width: 100%;\n  height: 100%;\n}\n\n.radio-con {\n  width: 100%;\n  display: flex;\n  flex-wrap: wrap;\n\n  .radio-item {\n    margin-bottom: 20rpx;\n\n    &:nth-child(3n+1) {\n      margin-left: 30rpx;\n    }\n\n    &:nth-child(3n+2) {\n      margin: 0 30rpx;\n    }\n  }\n}\n\n.title-con {\n  display: flex;\n  justify-content: space-between;\n}\n</style>\n","import MiniProgramPage from '/Users/jing/Code/mini/vehicle-info/pages/trace/trace.vue'\nwx.createPage(MiniProgramPage)"],"names":["useQueue","ref","getLocationApi","getTodayTimestampRange","getTraceApi","formatDateTime","randomRgbColor","res","wgs84togcj02","i","getDeptApi","onShow"],"mappings":"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"}
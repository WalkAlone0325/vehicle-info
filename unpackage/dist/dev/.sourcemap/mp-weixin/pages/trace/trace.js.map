{"version":3,"file":"trace.js","sources":["pages/trace/trace.vue","pages/trace/trace.vue?type=page"],"sourcesContent":["<script setup>\nimport { ref } from 'vue'\nimport { getLocationApi, getDeptApi, getTraceApi } from '@/api'\nimport { useQueue } from '@/uni_modules/wot-design-uni'\nimport { onShow } from '@dcloudio/uni-app'\nimport { randomRgbColor, wgs84togcj02, formatDateTime, getTodayTimestampRange } from '@/utils'\n\nconst { closeOutside } = useQueue()\n\nconst curIdx = ref(0)\n\nconst dropRef = ref(null)\nconst dropRef2 = ref(null)\nconst scale = ref(7)\nconst plateNumber = ref()\nconst deptId = ref()\nconst markerList = ref([])\nconst data = ref({})\nconst markers = ref([])\n\nconst getData = async () => {\n  const res = await getLocationApi({\n    deptId: deptId.value,\n    plateNumber: plateNumber.value,\n  })\n  if (deptId.value) {\n    scale.value = 8\n  } else {\n    scale.value = 7\n  }\n  data.value = res.data\n  markerList.value = res.data.carVehicleInfoList.map((i, idx) => ({\n    iconPath: '/static/location.png',\n    latitude: i.latitude,\n    longitude: i.longitude,\n    id: idx + 1,\n    width: 20,\n    height: 20,\n    label: {\n      content: i.plateNumber,\n      borderWidth: 1,\n      borderColor: '#999',\n      bgColor: '#fff',\n      borderRadius: 2,\n      padding: 3\n    }\n  }))\n\n  markers.value = markerList.value\n}\n\nconst handleConfirm = () => {}\n\nconst model = ref({\n  plateNumber: '',\n  date: getTodayTimestampRange()\n})\nconst traceData = ref({})\nconst polyline = ref([]) // 路线\nconst getTraceData = async () => {\n  const res = await getTraceApi({\n    // deptId: deptId.value,\n    plateNumber: model.value.plateNumber,\n    startDate: formatDateTime(model.value.date[0]),\n    endDate: formatDateTime(model.value.date[1])\n  })\n  if(res.code === 200) {\n    traceData.value = res.data\n    polyline.value = res.data.queryRecordLocationListOutBeanList.map((i, idx) => {\n      return {\n        width: 3,\n        arrowLine: true,\n        color: randomRgbColor(),\n        points: handlePoints(i, idx)\n      }\n    })\n\n    markers.value = []\n    markers.value = allStopPoints.value.map((i, idx) => ({\n      iconPath: '/static/stop.png',\n      latitude: i.latitude,\n      longitude: i.longitude,\n      id: idx + 1,\n      width: 20,\n      height: 20,\n      label: {\n        content: getDay(i.time),\n        borderWidth: 1,\n        borderColor: '#999',\n        bgColor: '#fff',\n        borderRadius: 2,\n        padding: 3\n      }\n    }))\n  }\n}\n\nconst getDay = (timestemp) => {\n  const day = Math.floor(timestemp / (24*3600*1000))\n  const hour = Math.floor(timestemp / (3600*1000) % 24)\n  const minute = Math.floor(timestemp / (60*1000) % 60)\n  const second = Math.floor(timestemp / 1000 % 60)\n  const dayStr = day ? `${day}天` : ''\n  const hourStr = hour ? `${hour}时` : ''\n  const minuteStr = minute ? `${minute}分` : ''\n  const secondStr = second ? `${second}秒` : ''\n  return `${dayStr}${hourStr}${minuteStr}${secondStr}`\n}\n\nconst allStopPoints = ref([])\nconst handlePoints = (i, idx) => {\n  const arr = []\n  let setArr = []\n  const res = JSON.parse(i.locations).map(j => {\n    const res = wgs84togcj02(j[0], j[1])\n    arr.push({str: '' + res[0] + res[1], date: j[4], latitude: res[1], longitude: res[0],})\n    return {latitude: res[1], longitude: res[0], str: '' + res[0] + res[1], date: j[4]}\n  })\n  setArr = [...new Set(arr.map(i => i.str))]\n  const start = arr.find(i => i.str == setArr[0])\n  const end = arr.findLast(i => i.str == setArr[0])\n\n  function getTimestemp(date) {\n    return new Date(date.replace(' ', 'T')).getTime()\n  }\n\n  // 大于 5 分钟，停止\n  const time = getTimestemp(end.date) - getTimestemp(start.date)\n  if(time >= 300000) {\n    allStopPoints.value.push({...end, time})\n  }\n\n  return res\n}\n\nconst handleReset = () => {\n  model.value.date = getTodayTimestampRange()\n  model.value.plateNumber = ''\n  search()\n}\n\nconst search = () => {\n  if(curIdx.value === 0) {\n    markerList.value = []\n    data.value = {}\n    markers.value = []\n    getData()\n    dropRef.value.close()\n  } else if(curIdx.value === 1) {\n    markers.value = []\n    traceData.value = {}\n    polyline.value = []\n    allStopPoints.value = []\n    getTraceData()\n    dropRef2.value.close()\n  }\n}\nconst reset = () => {\n  if (!deptId.value && !plateNumber.value) return\n  plateNumber.value = undefined\n  deptId.value = undefined\n  search()\n}\n\nconst deptOptions = ref([])\nconst getDept = async () => {\n  const res = await getDeptApi()\n  deptOptions.value = res.data.filter((i) => i.pId != '0').map((i) => ({\n    label: i.name,\n    value: i.id\n  }))\n}\n\n// 改变drop\nconst clickDrop = (item, idx) => {\n  if(curIdx.value === idx) return\n  curIdx.value = idx\n  plateNumber.value = undefined\n  deptId.value = undefined\n  markerList.value = []\n  data.value = {}\n  markers.value = []\n\n  traceData.value = {}\n  polyline.value = []\n  if(curIdx.value !== 1) {\n    search()\n  }\n}\n\nonShow(() => {\n  getData()\n  getDept()\n})\n</script>\n\n<template>\n  <view class=\"trace-page\">\n    <view @click=\"closeOutside\">\n      <wd-drop-menu @click=\"clickDrop\" :idx=\"curIdx\">\n        <wd-drop-menu-item title=\"车辆位置\" ref=\"dropRef\">\n          <view class=\"drop-con\">\n            <wd-search v-model=\"plateNumber\" placeholder-left cancel-txt=\"重置\" @cancel=\"reset\" placeholder=\"请输入车牌号进行搜索\"\n              @search=\"search\" />\n            <wd-radio-group v-model=\"deptId\" shape=\"button\" @change=\"search\">\n              <view class=\"radio-con\">\n                <view class=\"radio-item\" v-for=\"i in deptOptions\" :key=\"i.value\">\n                  <wd-radio :value=\"i.value\">{{ i.label }}</wd-radio>\n                </view>\n              </view>\n            </wd-radio-group>\n          </view>\n        </wd-drop-menu-item>\n        <wd-drop-menu-item title=\"车辆轨迹\" ref=\"dropRef2\">\n          <view class=\"drop-con\">\n            <wd-form ref=\"form\" :model=\"model\">\n              <wd-cell-group border>\n                <wd-input\n                  label=\"车牌号\"\n                  label-width=\"80px\"\n                  prop=\"plateNumber\"\n                  clearable\n                  v-model=\"model.plateNumber\"\n                  placeholder=\"请输入车牌号进行查询\"\n                />\n                <wd-datetime-picker prop=\"date\" label-width=\"80px\" label=\"日期选择\" placeholder=\"请选择日期\" v-model=\"model.date\" @confirm=\"handleConfirm\" />\n              </wd-cell-group>\n              <view style=\"display: flex;justify-content: center; padding: 20rpx 30rpx;\">\n                <wd-button type=\"primary\" @click=\"search\">搜索</wd-button>\n                <view style=\"margin-right: 30rpx;\"></view>\n                <wd-button type=\"warning\" @click=\"handleReset\">重置</wd-button>\n              </view>\n            </wd-form>\n          </view>\n        </wd-drop-menu-item>\n      </wd-drop-menu>\n    </view>\n    <map id=\"map\" :polyline=\"polyline\" :scale=\"scale\" :longitude=\"data.longitude\" :latitude=\"data.latitude\" :markers=\"markers\"></map>\n  </view>\n</template>\n\n<style scoped lang=\"scss\">\n.trace-page,\nmap {\n  width: 100%;\n  height: 100%;\n}\n\n.radio-con {\n  width: 100%;\n  display: flex;\n  flex-wrap: wrap;\n\n  .radio-item {\n    margin-bottom: 20rpx;\n\n    &:nth-child(3n+1) {\n      margin-left: 30rpx;\n    }\n\n    &:nth-child(3n+2) {\n      margin: 0 30rpx;\n    }\n  }\n}\n\n.title-con {\n  display: flex;\n  justify-content: space-between;\n}\n</style>\n","import MiniProgramPage from '/Users/jing/Code/mini/vehicle-info/pages/trace/trace.vue'\nwx.createPage(MiniProgramPage)"],"names":["closeOutside","useQueue","curIdx","ref","dropRef","dropRef2","scale","plateNumber","deptId","markerList","data","markers","getData","res","getLocationApi","i","idx","handleConfirm","model","getTodayTimestampRange","traceData","polyline","getTraceData","getTraceApi","formatDateTime","randomRgbColor","handlePoints","allStopPoints","getDay","timestemp","day","hour","minute","second","dayStr","hourStr","minuteStr","secondStr","arr","setArr","j","wgs84togcj02","start","end","getTimestemp","date","time","handleReset","search","reset","deptOptions","getDept","getDeptApi","clickDrop","item","onShow","MiniProgramPage"],"mappings":"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"}
{"version":3,"file":"trace.js","sources":["pages/trace/trace.vue","pages/trace/trace.vue?type=page"],"sourcesContent":["<script setup>\r\nimport { ref } from 'vue'\r\nimport { getLocationApi, getDeptApi, getTraceApi } from '@/api'\r\nimport { useQueue } from '@/uni_modules/wot-design-uni'\r\nimport { onShow } from '@dcloudio/uni-app'\r\nimport { randomRgbColor, wgs84togcj02, formatDateTime } from '@/utils'\r\n\r\nconst { closeOutside } = useQueue()\r\n\r\nconst curIdx = ref(0)\r\n\r\nconst dropRef = ref(null)\r\nconst dropRef2 = ref(null)\r\nconst scale = ref(7)\r\nconst plateNumber = ref()\r\nconst deptId = ref()\r\nconst markerList = ref([])\r\nconst data = ref({})\r\nconst markers = ref([])\r\n\r\nconst getData = async () => {\r\n  const res = await getLocationApi({\r\n    deptId: deptId.value,\r\n    plateNumber: plateNumber.value,\r\n  })\r\n  if (deptId.value) {\r\n    scale.value = 8\r\n  } else {\r\n    scale.value = 7\r\n  }\r\n  data.value = res.data\r\n  markerList.value = res.data.carVehicleInfoList.map((i, idx) => ({\r\n    iconPath: '/static/location.png',\r\n    latitude: i.latitude,\r\n    longitude: i.longitude,\r\n    id: idx + 1,\r\n    width: 20,\r\n    height: 20,\r\n    label: {\r\n      content: i.plateNumber,\r\n      borderWidth: 1,\r\n      borderColor: '#999',\r\n      bgColor: '#fff',\r\n      borderRadius: 2,\r\n      padding: 3\r\n    }\r\n  }))\r\n\r\n  markers.value = markerList.value\r\n}\r\n\r\nconst traceData = ref({})\r\nconst polyline = ref([]) // 路线\r\nconst getTraceData = async () => {\n  const now = new Date()\n  const twoHourAgo = new Date(now)\n  twoHourAgo.setHours(new Date().getHours() - 2)\r\n  const res = await getTraceApi({\n    deptId: deptId.value,\n    plateNumber: plateNumber.value,\r\n    startDate: formatDateTime(twoHourAgo),\r\n    endDate: formatDateTime(new Date())\r\n  })\r\n  if(res.code === 200) {\r\n    traceData.value = res.data\r\n    polyline.value = res.data.queryRecordLocationListOutBeanList.map((i, idx) => {\r\n      return {\r\n        width: 3,\r\n        arrowLine: true,\r\n        color: randomRgbColor(),\r\n        points: handlePoints(i, idx)\r\n      }\r\n    })\r\n\n    markers.value = []\r\n    markers.value = allStopPoints.value.map((i, idx) => ({\r\n      iconPath: '/static/stop.png',\r\n      latitude: i.latitude,\r\n      longitude: i.longitude,\r\n      id: idx + 1,\r\n      width: 20,\r\n      height: 20,\r\n      label: {\r\n        content: getDay(i.time),\r\n        borderWidth: 1,\r\n        borderColor: '#999',\r\n        bgColor: '#fff',\r\n        borderRadius: 2,\r\n        padding: 3\r\n      }\r\n    }))\r\n  }\r\n}\r\n\r\nconst getDay = (timestemp) => {\r\n  const day = Math.floor(timestemp / (24*3600*1000))\r\n  const hour = Math.floor(timestemp / (3600*1000) % 24)\r\n  const minute = Math.floor(timestemp / (60*1000) % 60)\r\n  const second = Math.floor(timestemp / 1000 % 60)\r\n  const dayStr = day ? `${day}天` : ''\r\n  const hourStr = hour ? `${hour}时` : ''\r\n  const minuteStr = minute ? `${minute}分` : ''\r\n  const secondStr = second ? `${second}秒` : ''\r\n  return `${dayStr}${hourStr}${minuteStr}${secondStr}`\r\n}\r\n\r\nconst allStopPoints = ref([])\r\nconst handlePoints = (i, idx) => {\r\n  const arr = []\r\n  let setArr = []\r\n  const res = JSON.parse(i.locations).map(j => {\r\n    const res = wgs84togcj02(j[0], j[1])\r\n    arr.push({str: '' + res[0] + res[1], date: j[4], latitude: res[1], longitude: res[0],})\r\n    return {latitude: res[1], longitude: res[0], str: '' + res[0] + res[1], date: j[4]}\r\n  })\r\n  setArr = [...new Set(arr.map(i => i.str))]\r\n  const start = arr.find(i => i.str == setArr[0])\r\n  const end = arr.findLast(i => i.str == setArr[0])\r\n\r\n  function getTimestemp(date) {\r\n    return new Date(date.replace(' ', 'T')).getTime()\r\n  }\r\n\r\n  // 大于 5 分钟，停止\r\n  const time = getTimestemp(end.date) - getTimestemp(start.date)\r\n  if(time >= 300000) {\r\n    allStopPoints.value.push({...end, time})\r\n  }\r\n\r\n  return res\r\n}\r\n\r\nconst search = () => {\r\n  if(curIdx.value === 0) {\n    markerList.value = []\n    data.value = {}\n    markers.value = []\r\n    getData()\r\n    dropRef.value.close()\r\n  } else if(curIdx.value === 1) {\n    markers.value = []\n    traceData.value = {}\n    polyline.value = []\n    allStopPoints.value = []\r\n    getTraceData()\r\n    dropRef2.value.close()\r\n  }\r\n}\r\nconst reset = () => {\r\n  if (!deptId.value && !plateNumber.value) return\r\n  plateNumber.value = undefined\r\n  deptId.value = undefined\r\n  search()\r\n}\r\n\r\nconst deptOptions = ref([])\r\nconst getDept = async () => {\r\n  const res = await getDeptApi()\r\n  deptOptions.value = res.data.filter((i) => i.pId != '0').map((i) => ({\r\n    label: i.name,\r\n    value: i.id\r\n  }))\r\n}\r\n\r\n// 改变drop\r\nconst clickDrop = (item, idx) => {\r\n  if(curIdx.value === idx) return\r\n  curIdx.value = idx\r\n  plateNumber.value = undefined\r\n  deptId.value = undefined\r\n  markerList.value = []\r\n  data.value = {}\r\n  markers.value = []\r\n\r\n  traceData.value = {}\r\n  polyline.value = []\r\n  search()\r\n}\r\n\r\nonShow(() => {\r\n  getData()\r\n  getDept()\r\n})\r\n</script>\r\n\r\n<template>\r\n  <view class=\"trace-page\">\r\n    <view @click=\"closeOutside\">\r\n      <wd-drop-menu @click=\"clickDrop\" :idx=\"curIdx\">\r\n        <wd-drop-menu-item title=\"车辆位置\" ref=\"dropRef\">\r\n          <view class=\"drop-con\">\r\n            <wd-search v-model=\"plateNumber\" placeholder-left cancel-txt=\"重置\" @cancel=\"reset\" placeholder=\"请输入车牌号进行搜索\"\r\n              @search=\"search\" />\r\n            <wd-radio-group v-model=\"deptId\" shape=\"button\" @change=\"search\">\r\n              <view class=\"radio-con\">\r\n                <view class=\"radio-item\" v-for=\"i in deptOptions\" :key=\"i.value\">\r\n                  <wd-radio :value=\"i.value\">{{ i.label }}</wd-radio>\r\n                </view>\r\n              </view>\r\n            </wd-radio-group>\r\n          </view>\r\n        </wd-drop-menu-item>\r\n        <wd-drop-menu-item title=\"车辆轨迹\" ref=\"dropRef2\">\r\n          <view class=\"drop-con\">\r\n            <wd-search v-model=\"plateNumber\" placeholder-left cancel-txt=\"重置\" @cancel=\"reset\" placeholder=\"请输入车牌号进行搜索\"\r\n              @search=\"search\" />\r\n            <wd-radio-group v-model=\"deptId\" shape=\"button\" @change=\"search\">\r\n              <view class=\"radio-con\">\r\n                <view class=\"radio-item\" v-for=\"i in deptOptions\" :key=\"i.value\">\r\n                  <wd-radio :value=\"i.value\">{{ i.label }}</wd-radio>\r\n                </view>\r\n              </view>\r\n            </wd-radio-group>\r\n          </view>\r\n        </wd-drop-menu-item>\r\n      </wd-drop-menu>\r\n    </view>\r\n    <map id=\"map\" :polyline=\"polyline\" :scale=\"scale\" :longitude=\"data.longitude\" :latitude=\"data.latitude\" :markers=\"markers\"></map>\r\n  </view>\r\n</template>\r\n\r\n<style scoped lang=\"scss\">\r\n.trace-page,\r\nmap {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n\r\n.radio-con {\r\n  width: 100%;\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n\r\n  .radio-item {\r\n    margin-bottom: 20rpx;\r\n\r\n    &:nth-child(3n+1) {\r\n      margin-left: 30rpx;\r\n    }\r\n\r\n    &:nth-child(3n+2) {\r\n      margin: 0 30rpx;\r\n    }\r\n  }\r\n}\r\n\r\n.title-con {\r\n  display: flex;\r\n  justify-content: space-between;\r\n}\r\n</style>\r\n","import MiniProgramPage from '/Users/jing/Code/mini/vehicle-info/pages/trace/trace.vue'\nwx.createPage(MiniProgramPage)"],"names":["useQueue","ref","getLocationApi","getTraceApi","formatDateTime","randomRgbColor","res","wgs84togcj02","i","getDeptApi","onShow"],"mappings":"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"}
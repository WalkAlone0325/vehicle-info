{"version":3,"file":"map.js","sources":["pages/index/map.vue","pages/index/map.vue?type=page"],"sourcesContent":["<script setup>\nimport { ref, toRaw } from 'vue'\nimport { onShow, onUnload } from '@dcloudio/uni-app'\nimport { randomRgbColor, getDistance } from '@/utils'\n\nconst mapRef = ref(null)\nconst map = ref(null)\nconst scale = ref(20)\nconst markers = ref([])\nconst polyline = ref([])\nconst data = ref({})\n// ÂàùÂßã‰ΩçÁΩÆ\nconst initLocation = ref({\n  latitude: '',\n  longitude: ''\n})\nconst currentData = ref({})\nconst minAccuracy = ref(0)\n\nconst markOrPolylineId = ref(1) // id\nconst curPolyline = ref({}) // ÁÇπÂáªÁöÑÁ∫ø\n\n// map ÁÇπÂáª\nconst handleClickMap = async (e, type) => {\n  switch (type) {\n    // Ê∑ªÂä†Ê†áÁÇπ„ÄÅÁ∫ø\n    case 'addMark':\n      uni.showModal({\n        title: 'ÊèêÁ§∫',\n        content: 'ÊòØÂê¶Á°ÆËÆ§Âú®Ê≠§Â§ÑÊ†áÁÇπÔºü',\n        success: async (res) => {\n          if (res.confirm) {\n            const { latitude, longitude } = e\n            addMarker(latitude, longitude, markOrPolylineId.value++)\n          }\n        },\n        fail: (err) => {\n          console.log(err, 'err')\n        }\n      })\n      break\n  }\n}\n\n// Ê∑ªÂä†Ê†áÁÇπ„ÄÅË∑ØÁ∫ø\nconst markerPoint = ref({})\nconst addMarker = (latitude, longitude, id) => {\n  // ‰∏ä‰∏ÄÊ¨°ÁöÑÁÇπ\n  const lastPoint = markerPoint.value.latitude ? toRaw(markerPoint.value) : {\n    latitude: initLocation.value.latitude,\n    longitude: initLocation.value.longitude\n  }\n  markerPoint.value = {\n    latitude,\n    longitude\n  }\n  // Á∫ø\n  polyline.value.push({\n    id,\n    points: [\n      lastPoint,\n      { latitude, longitude }\n    ],\n    width: 5,\n    clickable: true,\n    arrowLine: true,\n    color: randomRgbColor(),\n  })\n\n  // Ê†áÁÇπ\n  markers.value.push({\n    id,\n    latitude,\n    longitude,\n    iconPath: '../../static/current.png',\n    width: 30,\n    height: 30,\n    // label: {\n    //   content: getDistance(lastPoint.latitude, lastPoint.longitude, latitude, longitude),\n    //   borderWidth: 1,\n    //   borderColor: '#999',\n    //   bgColor: '#fff',\n    //   borderRadius: 2,\n    //   padding: 3\n    // }\n  })\n}\n\nconst o = ref(-1)\n// ÁÇπÂáªÊéß‰ª∂\nconst clickControl = async (type) => {\n  console.log('üöÄ:>> ', polyline.value)\n  const res = await getCurLocation()\n  // Êõ¥Êñ∞ÂÆö‰Ωç\n  if (type === 'local') {\n    console.log(res, 'current')\n    initLocation.value.latitude = res.latitude\n    initLocation.value.longitude = res.longitude\n  } else if (type === 'mark') {\n    // Ê∑ªÂä†Ê†áËÆ∞ÁÇπ„ÄÅË∑ØÁ∫ø\n    const arr = [\n      { latitude: 37.78155385785984, longitude: 112.56031978420128 },\n      { latitude: 37.78304276611586, longitude: 112.5613987268813 },\n      { latitude: 37.78167095013985, longitude: 112.55824860145844 }\n    ]\n    // handleClickMap(res, 'addMark')\n    o.value = o.value + 1\n    console.log('üöÄ:>> ', arr[o.value], o.value)\n    handleClickMap(arr[o.value], 'addMark')\n  }\n}\n\n// Ëé∑ÂèñÂÆö‰Ωç\nconst getCurLocation = () => {\n  return new Promise((resolve) => {\n    uni.getLocation({\n      type: 'gcj02',\n      isHighAccuracy: true,\n      success: (res) => {\n        currentData.value = res\n\n        if (!markers.value.length) {\n          initLocation.value.latitude = res.latitude\n          initLocation.value.longitude = res.longitude\n\n          markers.value = [\n            {\n              id: 1,\n              latitude: res.latitude,\n              longitude: res.longitude,\n              iconPath: '../../static/current.png',\n              width: 30,\n              height: 30\n            }\n          ]\n        }\n        resolve(res)\n      },\n      fail: (err) => console.log(err, 'err')\n    })\n  })\n}\n\n// ÂÆûÊó∂ÂÆö‰Ωç\nconst localChange = (res) => {\n  // console.log(res.latitude, res.longitude, res, 'ÂÆûÊó∂Êï∞ÊçÆ')\n\n  if (!minAccuracy.value || (res.accuracy.toFixed(2) * 100 < minAccuracy.value * 100)) {\n    minAccuracy.value = res.accuracy.toFixed(2)\n    // console.log(minAccuracy.value, 'Á≤æÂ∫¶')\n    data.value = [\n      { label: 'Á≤æÁ°ÆÂ∫¶', value: minAccuracy.value, unit: '' },\n      { label: 'ÈÄüÂ∫¶', value: res.speed.toFixed(2), unit: 'm/s' }\n    ]\n    currentData.value = res\n\n    if (!markers.value.length) {\n      initLocation.value.latitude = res.latitude\n      initLocation.value.longitude = res.longitude\n\n      markers.value = [\n        {\n          id: 1,\n          latitude: res.latitude,\n          longitude: res.longitude,\n          iconPath: '../../static/current.png',\n          width: 30,\n          height: 30\n        }\n      ]\n    }\n  }\n}\n\n// ÁÇπÂáªÁ∫øË∑Ø\nconst clickPolyline = (e) => {\n  const {latitude, longitude, polylineId} = e.detail\n  curPolyline.value = polyline.value.find(item => item.id === polylineId)\n  // ÁÇπÁ∫øË∑ØÂàõÂª∫ÈöêËóèÂºèÊ†áÁÇπÂ±ïÁ§∫‰ø°ÊÅØ\n  createHiddenMarker(latitude, longitude, curPolyline.value)\n}\n\n// ÂàõÂª∫ÈöêËóèÂºèÊ†áÁÇπ\nconst hiddenMarkId = ref(1000)\nconst createHiddenMarker = (latitude, longitude, curPolyline) => {\n  const arr = curPolyline.points\n  markers.value.push({\n    id: hiddenMarkId.value++,\n    latitude,\n    longitude,\n    iconPath: '',\n    width: 0,\n    height: 0,\n    title: getDistance(arr[0].latitude, arr[0].longitude, arr[1].latitude, arr[1].longitude)\n  })\n}\n\n// ÁÇπÂáªÊ†áÁÇπ\nconst clickMarker = (e) => {\n\n}\n\nonShow(async () => {\n  await getCurLocation()\n  // uni.startLocationUpdate({\n  //   success: () => {\n  //     console.log('ÂºÄÂêØÂ∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÊàêÂäü')\n  //     uni.onLocationChange((res) => {\n  //       localChange(res)\n  //       // Á≤æÁ°ÆÂ∫¶Â∞è‰∫é20Á±≥ÔºåÂÖ≥Èó≠ÂÆö‰Ωç\n  //       // if (res.accuracy.toFixed(2) * 100 < 2000) {\n  //       //   uni.stopLocationUpdate({\n  //       //     success: () => console.log('ÂÖ≥Èó≠Â∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÊàêÂäü'),\n  //       //     fail: err => console.error('ÂÖ≥Èó≠Â∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÂ§±Ë¥•Ôºö', err),\n  //       //     complete: msg => console.log('Ë∞ÉÁî®ÂÖ≥Èó≠Â∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØ API ÂÆåÊàê')\n  //       //   })\n  //       // }\n  //     })\n  //   },\n  //   fail: err => console.error('ÂºÄÂêØÂ∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÂ§±Ë¥•Ôºö', err),\n  //   complete: msg => console.log('Ë∞ÉÁî®ÂºÄÂêØÂ∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØ API ÂÆåÊàê')\n  // })\n})\nonUnload(() => {\n  uni.stopLocationUpdate({})\n})\n</script>\n\n<template>\n  <view class=\"map-con\">\n    <map id=\"map\" ref=\"map\" :enable-poi=\"false\" show-location show-compass enable-zoom enable-scroll :scale=\"scale\"\n      :longitude=\"initLocation.longitude\" :latitude=\"initLocation.latitude\" :markers=\"markers\" :polyline=\"polyline\" @tap=\"handleClickMap\" @markertap=\"clickMarker\" @polylinetap=\"clickPolyline\">\n\n      <!-- Êéß‰ª∂ -->\n      <view class=\"control-con\">\n        <view class=\"mark-con\" @click=\"clickControl('mark')\">\n          <image class=\"mark-img\" src=\"/static/mark.png\"></image>\n          <!-- <view class=\"mark-img\">Ê†áÁÇπ</view> -->\n        </view>\n        <view class=\"local-con\" @click=\"clickControl('local')\">\n          <image class=\"local-img\" src=\"/static/local.png\"></image>\n        </view>\n      </view>\n\n      <!-- ÂÆûÊó∂Êï∞ÊçÆ -->\n      <!-- <view class=\"data-con\">\n        <view class=\"data-item\" v-for=\"i in data\" :key=\"i.label\">\n          <view class=\"label\">{{ i.label }}Ôºö</view>\n          <view class=\"value\">{{ i.value + i.unit }}</view>\n        </view>\n      </view> -->\n    </map>\n\n  </view>\n</template>\n\n<style lang=\"scss\" scoped>\n.map-con,\n#map {\n  width: 100%;\n  height: 100%;\n}\n\n.info-con {\n  position: absolute;\n  padding: 12rpx;\n  background-color: #fff;\n  border-radius: 8rpx;\n}\n\n.control-con {\n  .local-con {\n    .local-img {\n      width: 80rpx;\n      height: 80rpx;\n      background-color: #fff;\n      padding: 12rpx;\n      border-radius: 8rpx;\n      box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.3);\n      position: absolute;\n      bottom: 120rpx;\n      left: 60rpx;\n      box-sizing: border-box;\n\n      &:active {\n        transform: scale(0.9);\n        box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.1);\n        transition: all 0.3s;\n        background-color: #f5f5f5;\n        padding: 14rpx;\n      }\n    }\n  }\n\n  .mark-con {\n    .mark-img {\n      width: 80rpx;\n      height: 80rpx;\n      background-color: #fff;\n      padding: 12rpx;\n      border-radius: 8rpx;\n      box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.3);\n      position: absolute;\n      bottom: 220rpx;\n      left: 60rpx;\n      box-sizing: border-box;\n\n      &:active {\n        transform: scale(0.9);\n        box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.1);\n        transition: all 0.3s;\n        background-color: #f5f5f5;\n        padding: 14rpx;\n      }\n    }\n  }\n}\n\n.data-con {\n  background-color: #fff;\n  padding: 10rpx;\n  border-radius: 8rpx;\n  position: absolute;\n  bottom: 100rpx;\n  right: 30rpx;\n\n  .data-item {\n    display: flex;\n\n    .label {\n      color: #666;\n    }\n  }\n}\n</style>\n","import MiniProgramPage from '/Users/jing/Code/mini/vehicle-info/pages/index/map.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","toRaw","randomRgbColor","curPolyline","getDistance","onShow","onUnload"],"mappings":"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"}
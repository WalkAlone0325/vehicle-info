{"version":3,"file":"map.js","sources":["pages/index/map.vue","pages/index/map.vue?type=page"],"sourcesContent":["<script setup>\nimport { ref, toRaw } from 'vue'\nimport { onShow, onUnload } from '@dcloudio/uni-app'\nimport { randomRgbColor, getDistance } from '@/utils'\n\nconst mapRef = ref(null)\nconst map = ref(null)\nconst scale = ref(20)\nconst markers = ref([])\nconst polyline = ref([])\nconst data = ref({})\n// ÂàùÂßã‰ΩçÁΩÆ\nconst initLocation = ref({\n  latitude: '',\n  longitude: ''\n})\nconst currentData = ref({})\nconst minAccuracy = ref(0)\n\nconst markOrPolylineId = ref(1) // id\nconst curPolyline = ref({}) // ÁÇπÂáªÁöÑÁ∫ø\n\n// map ÁÇπÂáª\nconst handleClickMap = async (e, type) => {\n  switch (type) {\n    // Ê∑ªÂä†Ê†áÁÇπ„ÄÅÁ∫ø\n    case 'addMark':\n      uni.showModal({\n        title: 'ÊèêÁ§∫',\n        content: 'ÊòØÂê¶Á°ÆËÆ§Âú®Ê≠§Â§ÑÊ†áÁÇπÔºü',\n        success: async (res) => {\n          if (res.confirm) {\n            const { latitude, longitude } = e\n            addMarker(latitude, longitude, markOrPolylineId.value++)\n          }\n        },\n        fail: (err) => {\n          console.log(err, 'err')\n        }\n      })\n      break\n  }\n}\n\n// Ê∑ªÂä†Ê†áÁÇπ„ÄÅË∑ØÁ∫ø\nconst markerPoint = ref({})\nconst addMarker = (latitude, longitude, id) => {\n  // ‰∏ä‰∏ÄÊ¨°ÁöÑÁÇπ\n  const lastPoint = markerPoint.value.latitude ? toRaw(markerPoint.value) : {\n    latitude: initLocation.value.latitude,\n    longitude: initLocation.value.longitude\n  }\n  markerPoint.value = {\n    latitude,\n    longitude\n  }\n  // Á∫ø\n  polyline.value.push({\n    id,\n    points: [\n      lastPoint,\n      { latitude, longitude }\n    ],\n    width: 5,\n    clickable: true,\n    arrowLine: true,\n    color: randomRgbColor(),\n  })\n\n  // Ê†áÁÇπ\n  markers.value.push({\n    id,\n    latitude,\n    longitude,\n    iconPath: '../../static/current.png',\n    width: 30,\n    height: 30,\n    // label: {\n    //   content: getDistance(lastPoint.latitude, lastPoint.longitude, latitude, longitude),\n    //   borderWidth: 1,\n    //   borderColor: '#999',\n    //   bgColor: '#fff',\n    //   borderRadius: 2,\n    //   padding: 3\n    // }\n  })\n}\n\nconst o = ref(-1)\n// ÁÇπÂáªÊéß‰ª∂\nconst clickControl = async (type) => {\n  console.log('üöÄ:>> ', polyline.value)\n  const res = await getCurLocation()\n  // Êõ¥Êñ∞ÂÆö‰Ωç\n  if (type === 'local') {\n    console.log(res, 'current')\n    initLocation.value.latitude = res.latitude\n    initLocation.value.longitude = res.longitude\n  } else if (type === 'mark') {\n    // Ê∑ªÂä†Ê†áËÆ∞ÁÇπ„ÄÅË∑ØÁ∫ø\n    const arr = [\n      { latitude: 37.78155385785984, longitude: 112.56031978420128 },\n      { latitude: 37.78304276611586, longitude: 112.5613987268813 },\n      { latitude: 37.78167095013985, longitude: 112.55824860145844 }\n    ]\n    // handleClickMap(res, 'addMark')\n    o.value = o.value + 1\n    console.log('üöÄ:>> ', arr[o.value], o.value)\n    handleClickMap(arr[o.value], 'addMark')\n  }\n}\n\n// Ëé∑ÂèñÂÆö‰Ωç\nconst getCurLocation = () => {\n  return new Promise((resolve) => {\n    uni.getLocation({\n      type: 'gcj02',\n      isHighAccuracy: true,\n      success: (res) => {\n        currentData.value = res\n\n        if (!markers.value.length) {\n          initLocation.value.latitude = res.latitude\n          initLocation.value.longitude = res.longitude\n\n          markers.value = [\n            {\n              id: 1,\n              latitude: res.latitude,\n              longitude: res.longitude,\n              iconPath: '../../static/current.png',\n              width: 30,\n              height: 30\n            }\n          ]\n        }\n        resolve(res)\n      },\n      fail: (err) => console.log(err, 'err')\n    })\n  })\n}\n\n// ÂÆûÊó∂ÂÆö‰Ωç\nconst localChange = (res) => {\n  // console.log(res.latitude, res.longitude, res, 'ÂÆûÊó∂Êï∞ÊçÆ')\n\n  if (!minAccuracy.value || (res.accuracy.toFixed(2) * 100 < minAccuracy.value * 100)) {\n    minAccuracy.value = res.accuracy.toFixed(2)\n    // console.log(minAccuracy.value, 'Á≤æÂ∫¶')\n    data.value = [\n      { label: 'Á≤æÁ°ÆÂ∫¶', value: minAccuracy.value, unit: '' },\n      { label: 'ÈÄüÂ∫¶', value: res.speed.toFixed(2), unit: 'm/s' }\n    ]\n    currentData.value = res\n\n    if (!markers.value.length) {\n      initLocation.value.latitude = res.latitude\n      initLocation.value.longitude = res.longitude\n\n      markers.value = [\n        {\n          id: 1,\n          latitude: res.latitude,\n          longitude: res.longitude,\n          iconPath: '../../static/current.png',\n          width: 30,\n          height: 30\n        }\n      ]\n    }\n  }\n}\n\n// ÁÇπÂáªÁ∫øË∑Ø\nconst clickPolyline = (e) => {\n  const {latitude, longitude, polylineId} = e.detail\n  curPolyline.value = polyline.value.find(item => item.id === polylineId)\n  // ÁÇπÁ∫øË∑ØÂàõÂª∫ÈöêËóèÂºèÊ†áÁÇπÂ±ïÁ§∫‰ø°ÊÅØ\n  createHiddenMarker(latitude, longitude, curPolyline.value)\n}\n\n// ÂàõÂª∫ÈöêËóèÂºèÊ†áÁÇπ\nconst hiddenMarkId = ref(1000)\nconst createHiddenMarker = (latitude, longitude, curPolyline) => {\n  const arr = curPolyline.points\n  markers.value.push({\n    id: hiddenMarkId.value++,\n    latitude,\n    longitude,\n    iconPath: '',\n    width: 0,\n    height: 0,\n    title: getDistance(arr[0].latitude, arr[0].longitude, arr[1].latitude, arr[1].longitude)\n  })\n}\n\n// ÁÇπÂáªÊ†áÁÇπ\nconst clickMarker = (e) => {\n\n}\n\nonShow(async () => {\n  await getCurLocation()\n  // uni.startLocationUpdate({\n  //   success: () => {\n  //     console.log('ÂºÄÂêØÂ∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÊàêÂäü')\n  //     uni.onLocationChange((res) => {\n  //       localChange(res)\n  //       // Á≤æÁ°ÆÂ∫¶Â∞è‰∫é20Á±≥ÔºåÂÖ≥Èó≠ÂÆö‰Ωç\n  //       // if (res.accuracy.toFixed(2) * 100 < 2000) {\n  //       //   uni.stopLocationUpdate({\n  //       //     success: () => console.log('ÂÖ≥Èó≠Â∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÊàêÂäü'),\n  //       //     fail: err => console.error('ÂÖ≥Èó≠Â∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÂ§±Ë¥•Ôºö', err),\n  //       //     complete: msg => console.log('Ë∞ÉÁî®ÂÖ≥Èó≠Â∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØ API ÂÆåÊàê')\n  //       //   })\n  //       // }\n  //     })\n  //   },\n  //   fail: err => console.error('ÂºÄÂêØÂ∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØÂ§±Ë¥•Ôºö', err),\n  //   complete: msg => console.log('Ë∞ÉÁî®ÂºÄÂêØÂ∫îÁî®Êé•Êî∂‰ΩçÁΩÆÊ∂àÊÅØ API ÂÆåÊàê')\n  // })\n})\nonUnload(() => {\n  uni.stopLocationUpdate({})\n})\n</script>\n\n<template>\n  <view class=\"map-con\">\n    <map id=\"map\" ref=\"map\" :enable-poi=\"false\" show-location show-compass enable-zoom enable-scroll :scale=\"scale\"\n      :longitude=\"initLocation.longitude\" :latitude=\"initLocation.latitude\" :markers=\"markers\" :polyline=\"polyline\" @tap=\"handleClickMap\" @markertap=\"clickMarker\" @polylinetap=\"clickPolyline\">\n\n      <!-- Êéß‰ª∂ -->\n      <view class=\"control-con\">\n        <view class=\"mark-con\" @click=\"clickControl('mark')\">\n          <image class=\"mark-img\" src=\"/static/mark.png\"></image>\n          <!-- <view class=\"mark-img\">Ê†áÁÇπ</view> -->\n        </view>\n        <view class=\"local-con\" @click=\"clickControl('local')\">\n          <image class=\"local-img\" src=\"/static/local.png\"></image>\n        </view>\n      </view>\n\n      <!-- ÂÆûÊó∂Êï∞ÊçÆ -->\n      <!-- <view class=\"data-con\">\n        <view class=\"data-item\" v-for=\"i in data\" :key=\"i.label\">\n          <view class=\"label\">{{ i.label }}Ôºö</view>\n          <view class=\"value\">{{ i.value + i.unit }}</view>\n        </view>\n      </view> -->\n    </map>\n\n  </view>\n</template>\n\n<style lang=\"scss\" scoped>\n.map-con,\n#map {\n  width: 100%;\n  height: 100%;\n}\n\n.info-con {\n  position: absolute;\n  padding: 12rpx;\n  background-color: #fff;\n  border-radius: 8rpx;\n}\n\n.control-con {\n  .local-con {\n    .local-img {\n      width: 80rpx;\n      height: 80rpx;\n      background-color: #fff;\n      padding: 12rpx;\n      border-radius: 8rpx;\n      box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.3);\n      position: absolute;\n      bottom: 120rpx;\n      left: 60rpx;\n      box-sizing: border-box;\n\n      &:active {\n        transform: scale(0.9);\n        box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.1);\n        transition: all 0.3s;\n        background-color: #f5f5f5;\n        padding: 14rpx;\n      }\n    }\n  }\n\n  .mark-con {\n    .mark-img {\n      width: 80rpx;\n      height: 80rpx;\n      background-color: #fff;\n      padding: 12rpx;\n      border-radius: 8rpx;\n      box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.3);\n      position: absolute;\n      bottom: 220rpx;\n      left: 60rpx;\n      box-sizing: border-box;\n\n      &:active {\n        transform: scale(0.9);\n        box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.1);\n        transition: all 0.3s;\n        background-color: #f5f5f5;\n        padding: 14rpx;\n      }\n    }\n  }\n}\n\n.data-con {\n  background-color: #fff;\n  padding: 10rpx;\n  border-radius: 8rpx;\n  position: absolute;\n  bottom: 100rpx;\n  right: 30rpx;\n\n  .data-item {\n    display: flex;\n\n    .label {\n      color: #666;\n    }\n  }\n}\n</style>\n","import MiniProgramPage from '/Users/jing/Code/mini/vehicle-info/pages/index/map.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","scale","markers","polyline","initLocation","currentData","markOrPolylineId","curPolyline","handleClickMap","e","type","uni","res","latitude","longitude","addMarker","err","markerPoint","id","lastPoint","toRaw","randomRgbColor","o","clickControl","getCurLocation","arr","resolve","clickPolyline","polylineId","item","createHiddenMarker","hiddenMarkId","getDistance","clickMarker","onShow","onUnload","MiniProgramPage"],"mappings":"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"}
{"version":3,"file":"map.js","sources":["pages/index/map.vue","pages/index/map.vue?type=page"],"sourcesContent":["<script setup>\nimport { ref, toRaw } from 'vue'\nimport { onReady, onShow, onUnload } from '@dcloudio/uni-app'\nimport { randomRgbColor, getDistance } from '@/utils'\n\nconst mapRef = ref(null)\nconst map = ref(null)\nconst scale = ref(20)\nconst markers = ref([])\nconst polyline = ref([])\nconst data = ref({})\n// 初始位置\nconst initLocation = ref({\n  latitude: '',\n  longitude: ''\n})\nconst currentData = ref({})\nconst minAccuracy = ref(0)\n\nconst clickMap = (e) => {\n  console.log(e, 'e')\n  uni.showModal({\n    title: '提示',\n    content: '是否确认在此处标点？',\n    success: async (res) => {\n      if (res.confirm) {\n        const { latitude, longitude } = e.detail\n        addMarker(latitude, longitude, e.timeStamp)\n      }\n    },\n    fail: (err) => {\n      console.log(err, 'err')\n    }\n  })\n}\n\nconst markerPoint = ref({})\nconst addMarker = (latitude, longitude, timeStamp) => {\n  // 上一次的点\n  const lastPoint = markerPoint.value.latitude ? toRaw(markerPoint.value) : {\n    latitude: initLocation.value.latitude,\n    longitude: initLocation.value.longitude\n  }\n  markerPoint.value = {\n    latitude,\n    longitude\n  }\n  // 线\n  polyline.value.push({\n    id: timeStamp,\n    points: [\n      lastPoint,\n      { latitude, longitude }\n    ],\n    width: 3,\n    arrowLine: true,\n    color: randomRgbColor(),\n  })\n\n  // 标点\n  markers.value.push({\n    id: timeStamp,\n    latitude,\n    longitude,\n    iconPath: '../../static/current.png',\n    width: 20,\n    height: 20,\n    label: {\n      content: getDistance(lastPoint.latitude, lastPoint.longitude, latitude, longitude),\n      borderWidth: 1,\n      borderColor: '#999',\n      bgColor: '#fff',\n      borderRadius: 2,\n      padding: 3\n    }\n  })\n}\n\n// 点击控件\nconst clickControl = () => {\n  console.log(currentData.value, 'current')\n  initLocation.value.latitude = currentData.value.latitude\n  initLocation.value.longitude = currentData.value.longitude\n}\n\n// 实时定位\nconst localChange = (res) => {\n  console.log(res.accuracy.toFixed(2) * 100, minAccuracy.value * 100, res.accuracy.toFixed(2) * 100 < minAccuracy.value * 100, '实时数据')\n  if (!minAccuracy.value || (res.accuracy.toFixed(2) * 100 < minAccuracy.value * 100)) {\n    minAccuracy.value = res.accuracy.toFixed(2)\n    console.log(minAccuracy.value, 666)\n    data.value = [\n      { label: '精确度', value: minAccuracy.value, unit: '' },\n      { label: '速度', value: res.speed.toFixed(2), unit: 'm/s' }\n    ]\n    currentData.value = res\n\n    initLocation.value.latitude = res.latitude\n    initLocation.value.longitude = res.longitude\n\n    markers.value = [\n      {\n        id: 1,\n        latitude: res.latitude,\n        longitude: res.longitude,\n        iconPath: '../../static/current.png',\n        width: 20,\n        height: 20\n      }\n    ]\n  }\n}\n\nonShow(() => {\n  uni.startLocationUpdate({\n    success: () => {\n      console.log('开启应用接收位置消息成功')\n      uni.onLocationChange((res) => {\n        localChange(res)\n        // 精确度小于20米，关闭定位\n        if (res.accuracy.toFixed(2) * 100 < 2000) {\n          uni.stopLocationUpdate({\n            success: () => console.log('关闭应用接收位置消息成功'),\n            fail: err => console.error('关闭应用接收位置消息失败：', err),\n            complete: msg => console.log('调用关闭应用接收位置消息 API 完成')\n          })\n        }\n      })\n    },\n    fail: err => console.error('开启应用接收位置消息失败：', err),\n    complete: msg => console.log('调用开启应用接收位置消息 API 完成')\n  })\n})\nonUnload(() => {\n  uni.stopLocationUpdate({})\n})\n</script>\n\n<template>\n  <view class=\"map-con\">\n    <map id=\"map\" ref=\"map\" show-location show-compass enable-zoom enable-scroll :scale=\"scale\"\n      :longitude=\"initLocation.longitude\" :latitude=\"initLocation.latitude\" :markers=\"markers\" :polyline=\"polyline\"\n      @tap=\"clickMap\">\n\n      <view class=\"local-con\" @click=\"clickControl\">\n        <image class=\"local-img\" src=\"/static/local.png\"></image>\n      </view>\n\n      <view class=\"data-con\">\n        <view class=\"data-item\" v-for=\"i in data\" :key=\"i.label\">\n          <view class=\"label\">{{ i.label }}：</view>\n          <view class=\"value\">{{ i.value + i.unit }}</view>\n        </view>\n      </view>\n    </map>\n\n  </view>\n</template>\n\n<style lang=\"scss\" scoped>\n.map-con,\n#map {\n  width: 100%;\n  height: 100%;\n}\n\n.local-con {\n  .local-img {\n    width: 80rpx;\n    height: 80rpx;\n    background-color: #fff;\n    padding: 12rpx;\n    border-radius: 8rpx;\n    box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.3);\n    position: absolute;\n    bottom: 220rpx;\n    left: 60rpx;\n    box-sizing: border-box;\n\n    &:active {\n      transform: scale(0.9);\n      box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.1);\n      transition: all 0.3s;\n      background-color: #f5f5f5;\n      padding: 14rpx;\n    }\n  }\n}\n\n.data-con {\n  background-color: #fff;\n  padding: 10rpx;\n  border-radius: 8rpx;\n  position: absolute;\n  bottom: 100rpx;\n  right: 30rpx;\n\n  .data-item {\n    display: flex;\n\n    .label {\n      color: #666;\n    }\n  }\n}\n</style>\n","import MiniProgramPage from '/Users/jing/Code/mini/vehicle-info/pages/index/map.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","toRaw","randomRgbColor","getDistance","onShow","onUnload"],"mappings":"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"}
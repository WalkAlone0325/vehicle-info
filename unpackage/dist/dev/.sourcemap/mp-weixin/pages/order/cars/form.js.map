{"version":3,"file":"form.js","sources":["pages/order/cars/form.vue","pages/order/cars/form.vue?type=page"],"sourcesContent":["<script setup>\nimport { ref } from 'vue'\nimport { getOrderDetail, getDictApi, putOrder, postOrder, getEndOrderList,getCarListApi,getDriverListApi,getUserListApi } from '@/api'\nimport { onLoad } from '@dcloudio/uni-app'\nimport http from '@/utils/request'\nimport { getToken } from '@/utils'\n\nconst options = ref([])\nconst loading = ref(false)\nconst form = ref(null)\nconst model = ref({\n  collectDriverId: '',\n  collectDriverName: '',\n  collectVehicleId: '',\n  returnedDriverId: '',\n  collectPlateNumber: '',\n  returnedDriverName: '',\n  workOrdeStatusCode: 'waiting_collect',\n  useCarApplicationOrderId: '',\n  applicantUserId: '',\n  applicantUserName: '',\n  collectMileage: '',\n  returnedMileage: '',\n  returnedTime: '',\n  collectMileagePictureId: '',\n  collectPlateNumberPictureId: '',\n  remark: '',\n  files1: [],\n  files2: [],\n  files3: [],\n})\nconst rules = ref({\n  useCarApplicationOrderId: [{ required: true, message: '请选择用车申请工单' }],\n})\nconst getDetail = async (id) => {\n  const res = await getOrderDetail(id)\n  model.value = {\n    ...res.data,\n    files1: res.data.collectPlateNumberPictureId ? [{ossId: res.data.collectPlateNumberPictureId, url: res.data.collectPlateNumberPictureUrl}] : [],\n    files2: res.data.collectMileagePictureId ? [{ossId: res.data.collectMileagePictureId, url: res.data.collectMileagePictureUrl}] : [],\n    files3: res.data.returnedMileagePictureId ? [{ossId: res.data.returnedMileagePictureId, url: res.data.returnedMileagePictureUrl}] : [],\n  }\n}\n\nconst list = ref([])\nconst getList = async () => {\n  const res = await getEndOrderList()\n  list.value = res.rows.map(i => ({...i, str: `${i.expectedPlateNumber} ${i.expectedDriverName} / ${i.approvePlateNumber || ''} ${i.approveDriverName || ''}`}))\n}\nconst handleCode = ({ value }) => {\n  const find = list.value.find(item => item.useCarApplicationOrderId == value)\n  console.log('🚀:>> ', find)\n  model.value.collectDriverId = find.expectedDriverId\n  model.value.collectDriverName = find.expectedDriverName\n  model.value.collectVehicleId = find.expectedVehicleId\n  model.value.collectPlateNumber = find.expectedPlateNumber\n  model.value.returnedDriverId = find.approveDriverId\n  model.value.returnedDriverName = find.approveDriverName\n  model.value.applicantUserId = find.applicantUserId\n  model.value.applicantUserName = find.applicantUserName\n}\n// 车辆\nconst carOptions = ref([])\nconst getCar = async () => {\n  const res = await getCarListApi({ vehicleStatusCode: 'NORMAL', vehicleTypeCode: model.value.vehicleTypeCode })\n  carOptions.value = res.rows\n}\n\n// 司机\nconst driverOptions = ref([])\nconst getDriver = async () => {\n  const res = await getDriverListApi()\n  driverOptions.value = res.rows\n}\n\n// 申请人\nconst userOptions = ref([])\nconst getUser = async () => {\n  const res = await getUserListApi()\n  userOptions.value = res.rows\n}\n\nconst getDict = async (code) => {\n  const res = await getDictApi(code)\n  options.value = res.data\n}\n\nconst handleSubmit = (type) => {\n  form.value\n    .validate()\n    .then(async ({ valid, errors }) => {\n      if (valid) {\n        loading.value = true\n        // 提交表单数据\n        let res\n        if (model.value.useCarWorkOrderId) {\n          if(type === 'collect') {\n            // 领车\n            model.value.workOrdeStatusCode = 'collect'\n          } else if(type === 'returned') {\n            // 还车\n            model.value.workOrdeStatusCode = 'returned'\n          }\n          res = await putOrder({\n            useCarWorkOrderId: model.value.useCarWorkOrderId,\n            useCarApplicationOrderId: model.value.useCarApplicationOrderId,\n            collectVehicleId: model.value.collectVehicleId,\n            collectPlateNumber: model.value.collectPlateNumber,\n            collectPlateNumberPictureId: model.value.collectPlateNumberPictureId,\n            collectDriverId: model.value.collectDriverId,\n            collectDriverName: model.value.collectDriverName,\n            collectMileage: model.value.collectMileage,\n            collectMileagePictureId: model.value.collectMileagePictureId,\n            returnedDriverId: model.value.returnedDriverId,\n            returnedDriverName: model.value.returnedDriverName,\n            returnedMileage: model.value.returnedMileage,\n            returnedMileagePictureId: model.value.returnedMileagePictureId,\n            returnedTime: model.value.returnedTime,\n            workOrdeStatusCode: model.value.workOrdeStatusCode,\n            applicantUserId: model.value.applicantUserId,\n            applicantUserName: model.value.applicantUserName\n          })\n        } else {\n          res = await postOrder(model.value)\n        }\n        if (res.code == 200) {\n          uni.showToast({\n            title: '提交成功',\n            icon: 'success',\n            duration: 1000,\n            success: () => {\n              setTimeout(() => {\n                loading.value = false\n                uni.navigateBack({\n                  delta: 1\n                })\n              }, 1000)\n            }\n          })\n        }\n        loading.value = false\n      }\n    })\n    .catch((error) => {\n      console.log(error, 'error')\n    })\n}\n\nconst changeUpload = (fileList, key) => {\n  model.value[key] = fileList[0].ossId\n}\n\nconst customUpload = (file, formData, options) => {\n  const uploadTask = uni.uploadFile({\n    url: http.config.baseURL + 'system/local/file/upload',\n    // url: 'https://sxnmggz.com:8448/prod-api/system/oss/upload',\n    header: {\n      ...options.header,\n      Authorization: `Bearer ${getToken()}`,\n      'Content-Type': 'multipart/form-data'\n    },\n    name: 'file',\n    fileName: 'file',\n    fileType: 'image',\n    formData,\n    filePath: file.url,\n    success: async (res) => {\n      const e = JSON.parse(res.data)\n      if (e.code == 200) {\n        // 设置上传成功\n        options.onSuccess(e, file, formData)\n        model.value.fileList = [{ url: e.data.url }]\n        toast.show('上传成功')\n      } else {\n        // 设置上传失败\n        options.onError({ ...e, errMsg: e.errMsg || '' }, file, formData)\n        toast.show('上传失败')\n      }\n    },\n    fail(err) {\n      // 设置上传失败\n      options.onError(err, file, formData)\n    }\n  })\n  // 设置当前文件加载的百分比\n  uploadTask.onProgressUpdate((res) => {\n    options.onProgress(res, file)\n  })\n}\n\nonLoad((param) => {\n  if (param.id) {\n    getDetail(param.id)\n  }\n  getDict('work_orde_status')\n  getList()\n  getCar()\n  getDriver()\n  getUser()\n})\n</script>\n\n<template>\n  <view class=\"info-page\">\n    <BaseForm>\n      <view class=\"form-con\">\n        <wd-form ref=\"form\" :model=\"model\" :rules=\"rules\" errorType=\"toast\">\n          <wd-cell-group border>\n            <wd-select-picker type=\"radio\" value-key=\"useCarApplicationOrderId\" label-key=\"str\"\n              label-width=\"100px\" prop=\"useCarApplicationOrderId\" label=\"申请工单编号\" placeholder=\"请选择用车申请工单编号\"\n              v-model=\"model.useCarApplicationOrderId\" :columns=\"list\" filterable @change=\"handleCode\" :show-confirm=\"false\" />\n\n            <wd-select-picker type=\"radio\" value-key=\"vehicleId\" label-key=\"plateNumber\"\n              label-width=\"100px\" prop=\"collectVehicleId\" label=\"领取车辆\" placeholder=\"请选择领取车辆\"\n              v-model=\"model.collectVehicleId\" :columns=\"carOptions\" filterable :show-confirm=\"false\" />\n\n            <wd-cell title=\"领取车辆照片\" title-width=\"100px\" prop=\"fileList\">\n               <BaseUpload :file-list=\"model.files1\" @update:fileList=\"(...args) => changeUpload(...args, 'collectPlateNumberPictureId')\" />\n            </wd-cell>\n\n            <wd-select-picker type=\"radio\" value-key=\"driverId\" label-key=\"driverName\" label-width=\"100px\"\n              prop=\"collectDriverId\" label=\"领车司机\" placeholder=\"请选择领车司机\" v-model=\"model.collectDriverId\"\n              :columns=\"driverOptions\" filterable :show-confirm=\"false\" />\n            <wd-input type=\"number\" label=\"实际起始里程\" label-width=\"100px\" prop=\"collectMileage\"\n              v-model=\"model.collectMileage\" placeholder=\"请输入实际起始里程\" />\n\n            <wd-cell title=\"实际起始里程照片\" title-width=\"100px\" prop=\"fileList\">\n               <BaseUpload :file-list=\"model.files2\" @update:fileList=\"(...args) => changeUpload(...args, 'collectMileagePictureId')\" />\n            </wd-cell>\n\n            <wd-select-picker type=\"radio\" value-key=\"driverId\" label-key=\"driverName\" label-width=\"100px\"\n              prop=\"returnedDriverId\" label=\"还车司机\" placeholder=\"请选择还车司机\" v-model=\"model.returnedDriverId\"\n              :columns=\"driverOptions\" filterable :show-confirm=\"false\" />\n\n            <wd-input type=\"number\" label=\"实际结束里程\" label-width=\"100px\" prop=\"returnedMileage\"\n              v-model=\"model.returnedMileage\" placeholder=\"请输入实际结束里程\" />\n            <wd-datetime-picker label=\"还车时间\" label-width=\"100px\" placeholder=\"请选择还车时间\" prop=\"returnedTime\" v-model=\"model.returnedTime\" />\n\n            <wd-cell title=\"实际结束里程照片\" title-width=\"100px\" prop=\"fileList\">\n               <BaseUpload :file-list=\"model.files3\" @update:fileList=\"(...args) => changeUpload(...args, 'returnedMileagePictureId')\" />\n            </wd-cell>\n\n            <wd-picker label=\"工单状态\" placeholder=\"请选择工单状态\" value-key=\"dictValue\" label-key=\"dictLabel\" label-width=\"100px\"\n              prop=\"workOrdeStatusCode\" v-model=\"model.workOrdeStatusCode\" :columns=\"options\" />\n\n            <wd-select-picker type=\"radio\" value-key=\"userId\" label-key=\"userName\" label-width=\"100px\"\n              prop=\"applicantUserId\" label=\"申请人\" placeholder=\"请选择申请人\" v-model=\"model.applicantUserId\"\n              :columns=\"userOptions\" filterable :show-confirm=\"false\" />\n\n            <wd-input label=\"备注\" label-width=\"100px\" prop=\"remark\" clearable v-model=\"model.remark\" placeholder=\"请输入备注\" />\n          </wd-cell-group>\n          <view class=\"footer\">\n            <wd-button type=\"primary\" :loading=\"loading\" @click=\"handleSubmit\">保存</wd-button>\n            <view style=\"margin-left: 40rpx;\" v-if=\"model.workOrdeStatusCode == 'waiting_collect'\"></view>\n            <wd-button type=\"success\" v-if=\"model.workOrdeStatusCode == 'waiting_collect'\" :loading=\"loading\" @click=\"handleSubmit('collect')\">领车</wd-button>\n            <view style=\"margin-left: 40rpx;\" v-if=\"model.workOrdeStatusCode == 'collect'\"></view>\n            <wd-button type=\"success\" v-if=\"model.workOrdeStatusCode == 'collect'\" :loading=\"loading\" @click=\"handleSubmit('returned')\">还车</wd-button>\n          </view>\n        </wd-form>\n      </view>\n    </BaseForm>\n  </view>\n</template>\n\n<style lang=\"scss\" scoped>\n.info-page {\n  .footer {\n    display: flex;\n    padding: 30rpx;\n    margin-top: 10rpx;\n    justify-content: center;\n  }\n\n  .form-con {\n    height: 30vh;\n    background-color: #fff;\n  }\n}\n</style>\n","import MiniProgramPage from '/Users/jing/Code/mini/vehicle-info/pages/order/cars/form.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","getOrderDetail","getEndOrderList","uni","getCarListApi","getDriverListApi","getUserListApi","getDictApi","putOrder","postOrder","onLoad"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAOA,UAAM,UAAUA,cAAG,IAAC,EAAE;AACtB,UAAM,UAAUA,cAAG,IAAC,KAAK;AACzB,UAAM,OAAOA,cAAG,IAAC,IAAI;AACrB,UAAM,QAAQA,cAAAA,IAAI;AAAA,MAChB,iBAAiB;AAAA,MACjB,mBAAmB;AAAA,MACnB,kBAAkB;AAAA,MAClB,kBAAkB;AAAA,MAClB,oBAAoB;AAAA,MACpB,oBAAoB;AAAA,MACpB,oBAAoB;AAAA,MACpB,0BAA0B;AAAA,MAC1B,iBAAiB;AAAA,MACjB,mBAAmB;AAAA,MACnB,gBAAgB;AAAA,MAChB,iBAAiB;AAAA,MACjB,cAAc;AAAA,MACd,yBAAyB;AAAA,MACzB,6BAA6B;AAAA,MAC7B,QAAQ;AAAA,MACR,QAAQ,CAAE;AAAA,MACV,QAAQ,CAAE;AAAA,MACV,QAAQ,CAAE;AAAA,IACZ,CAAC;AACD,UAAM,QAAQA,cAAAA,IAAI;AAAA,MAChB,0BAA0B,CAAC,EAAE,UAAU,MAAM,SAAS,YAAW,CAAE;AAAA,IACrE,CAAC;AACD,UAAM,YAAY,OAAO,OAAO;AAC9B,YAAM,MAAM,MAAMC,UAAc,eAAC,EAAE;AACnC,YAAM,QAAQ;AAAA,QACZ,GAAG,IAAI;AAAA,QACP,QAAQ,IAAI,KAAK,8BAA8B,CAAC,EAAC,OAAO,IAAI,KAAK,6BAA6B,KAAK,IAAI,KAAK,6BAA4B,CAAC,IAAI,CAAE;AAAA,QAC/I,QAAQ,IAAI,KAAK,0BAA0B,CAAC,EAAC,OAAO,IAAI,KAAK,yBAAyB,KAAK,IAAI,KAAK,yBAAwB,CAAC,IAAI,CAAE;AAAA,QACnI,QAAQ,IAAI,KAAK,2BAA2B,CAAC,EAAC,OAAO,IAAI,KAAK,0BAA0B,KAAK,IAAI,KAAK,0BAAyB,CAAC,IAAI,CAAE;AAAA,MACvI;AAAA,IACH;AAEA,UAAM,OAAOD,cAAG,IAAC,EAAE;AACnB,UAAM,UAAU,YAAY;AAC1B,YAAM,MAAM,MAAME,0BAAiB;AACnC,WAAK,QAAQ,IAAI,KAAK,IAAI,QAAM,EAAC,GAAG,GAAG,KAAK,GAAG,EAAE,mBAAmB,IAAI,EAAE,kBAAkB,MAAM,EAAE,sBAAsB,EAAE,IAAI,EAAE,qBAAqB,EAAE,GAAE,EAAE;AAAA,IAC/J;AACA,UAAM,aAAa,CAAC,EAAE,YAAY;AAChC,YAAM,OAAO,KAAK,MAAM,KAAK,UAAQ,KAAK,4BAA4B,KAAK;AAC3EC,oBAAAA,MAAY,MAAA,OAAA,mCAAA,UAAU,IAAI;AAC1B,YAAM,MAAM,kBAAkB,KAAK;AACnC,YAAM,MAAM,oBAAoB,KAAK;AACrC,YAAM,MAAM,mBAAmB,KAAK;AACpC,YAAM,MAAM,qBAAqB,KAAK;AACtC,YAAM,MAAM,mBAAmB,KAAK;AACpC,YAAM,MAAM,qBAAqB,KAAK;AACtC,YAAM,MAAM,kBAAkB,KAAK;AACnC,YAAM,MAAM,oBAAoB,KAAK;AAAA,IACvC;AAEA,UAAM,aAAaH,cAAG,IAAC,EAAE;AACzB,UAAM,SAAS,YAAY;AACzB,YAAM,MAAM,MAAMI,SAAa,cAAC,EAAE,mBAAmB,UAAU,iBAAiB,MAAM,MAAM,iBAAiB;AAC7G,iBAAW,QAAQ,IAAI;AAAA,IACzB;AAGA,UAAM,gBAAgBJ,cAAG,IAAC,EAAE;AAC5B,UAAM,YAAY,YAAY;AAC5B,YAAM,MAAM,MAAMK,0BAAkB;AACpC,oBAAc,QAAQ,IAAI;AAAA,IAC5B;AAGA,UAAM,cAAcL,cAAG,IAAC,EAAE;AAC1B,UAAM,UAAU,YAAY;AAC1B,YAAM,MAAM,MAAMM,yBAAgB;AAClC,kBAAY,QAAQ,IAAI;AAAA,IAC1B;AAEA,UAAM,UAAU,OAAO,SAAS;AAC9B,YAAM,MAAM,MAAMC,WAAU,WAAC,IAAI;AACjC,cAAQ,QAAQ,IAAI;AAAA,IACtB;AAEA,UAAM,eAAe,CAAC,SAAS;AAC7B,WAAK,MACF,SAAU,EACV,KAAK,OAAO,EAAE,OAAO,aAAa;AACjC,YAAI,OAAO;AACT,kBAAQ,QAAQ;AAEhB,cAAI;AACJ,cAAI,MAAM,MAAM,mBAAmB;AACjC,gBAAG,SAAS,WAAW;AAErB,oBAAM,MAAM,qBAAqB;AAAA,YAC7C,WAAoB,SAAS,YAAY;AAE7B,oBAAM,MAAM,qBAAqB;AAAA,YAClC;AACD,kBAAM,MAAMC,UAAAA,SAAS;AAAA,cACnB,mBAAmB,MAAM,MAAM;AAAA,cAC/B,0BAA0B,MAAM,MAAM;AAAA,cACtC,kBAAkB,MAAM,MAAM;AAAA,cAC9B,oBAAoB,MAAM,MAAM;AAAA,cAChC,6BAA6B,MAAM,MAAM;AAAA,cACzC,iBAAiB,MAAM,MAAM;AAAA,cAC7B,mBAAmB,MAAM,MAAM;AAAA,cAC/B,gBAAgB,MAAM,MAAM;AAAA,cAC5B,yBAAyB,MAAM,MAAM;AAAA,cACrC,kBAAkB,MAAM,MAAM;AAAA,cAC9B,oBAAoB,MAAM,MAAM;AAAA,cAChC,iBAAiB,MAAM,MAAM;AAAA,cAC7B,0BAA0B,MAAM,MAAM;AAAA,cACtC,cAAc,MAAM,MAAM;AAAA,cAC1B,oBAAoB,MAAM,MAAM;AAAA,cAChC,iBAAiB,MAAM,MAAM;AAAA,cAC7B,mBAAmB,MAAM,MAAM;AAAA,YAC3C,CAAW;AAAA,UACX,OAAe;AACL,kBAAM,MAAMC,UAAAA,UAAU,MAAM,KAAK;AAAA,UAClC;AACD,cAAI,IAAI,QAAQ,KAAK;AACnBN,0BAAAA,MAAI,UAAU;AAAA,cACZ,OAAO;AAAA,cACP,MAAM;AAAA,cACN,UAAU;AAAA,cACV,SAAS,MAAM;AACb,2BAAW,MAAM;AACf,0BAAQ,QAAQ;AAChBA,gCAAAA,MAAI,aAAa;AAAA,oBACf,OAAO;AAAA,kBACzB,CAAiB;AAAA,gBACF,GAAE,GAAI;AAAA,cACR;AAAA,YACb,CAAW;AAAA,UACF;AACD,kBAAQ,QAAQ;AAAA,QACjB;AAAA,MACP,CAAK,EACA,MAAM,CAAC,UAAU;AAChBA,sBAAAA,MAAY,MAAA,OAAA,oCAAA,OAAO,OAAO;AAAA,MAChC,CAAK;AAAA,IACL;AAEA,UAAM,eAAe,CAAC,UAAU,QAAQ;AACtC,YAAM,MAAM,GAAG,IAAI,SAAS,CAAC,EAAE;AAAA,IACjC;AAwCAO,kBAAM,OAAC,CAAC,UAAU;AAChB,UAAI,MAAM,IAAI;AACZ,kBAAU,MAAM,EAAE;AAAA,MACnB;AACD,cAAQ,kBAAkB;AAC1B,cAAS;AACT,aAAQ;AACR,gBAAW;AACX,cAAS;AAAA,IACX,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtMD,GAAG,WAAW,eAAe;"}
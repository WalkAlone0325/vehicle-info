{"version":3,"file":"wd-sticky.js","sources":["uni_modules/wot-design-uni/components/wd-sticky/wd-sticky.vue","/Users/jing/Code/mini/vehicle-info/uni_modules/wot-design-uni/components/wd-sticky/wd-sticky.vue?type=component"],"sourcesContent":["<template>\n  <view :style=\"`${rootStyle};display: inline-block;`\">\n    <view :class=\"`wd-sticky ${customClass}`\" :style=\"stickyStyle\" :id=\"styckyId\">\n      <view class=\"wd-sticky__container\" :style=\"containerStyle\">\n        <wd-resize @resize=\"handleResize\" custom-style=\"display: inline-block;\">\n          <slot />\n        </wd-resize>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script lang=\"ts\">\nexport default {\n  name: 'wd-sticky',\n  options: {\n    addGlobalClass: true,\n    virtualHost: true,\n    styleIsolation: 'shared'\n  }\n}\n</script>\n\n<script lang=\"ts\" setup>\nimport wdResize from '../wd-resize/wd-resize.vue'\nimport { computed, getCurrentInstance, reactive, ref, type CSSProperties } from 'vue'\nimport { addUnit, getRect, objToStyle, pause, uuid } from '../common/util'\nimport { stickyProps } from './types'\nimport { useParent } from '../composables/useParent'\nimport { STICKY_BOX_KEY } from '../wd-sticky-box/types'\n\nconst props = defineProps(stickyProps)\nconst styckyId = ref<string>(`wd-sticky${uuid()}`)\nconst observerList = ref<UniApp.IntersectionObserver[]>([])\n\nconst stickyState = reactive({\n  position: 'absolute',\n  boxLeaved: false,\n  top: 0,\n  height: 0,\n  width: 0,\n  state: ''\n})\n\nconst { parent: stickyBox } = useParent(STICKY_BOX_KEY)\n\nconst { proxy } = getCurrentInstance() as any\n\nconst rootStyle = computed(() => {\n  const style: CSSProperties = {\n    'z-index': props.zIndex,\n    height: addUnit(stickyState.height),\n    width: addUnit(stickyState.width)\n  }\n  if (!stickyState.boxLeaved) {\n    style['position'] = 'relative'\n  }\n  return `${objToStyle(style)}${props.customStyle}`\n})\n\nconst stickyStyle = computed(() => {\n  const style: CSSProperties = {\n    'z-index': props.zIndex,\n    height: addUnit(stickyState.height),\n    width: addUnit(stickyState.width)\n  }\n  if (!stickyState.boxLeaved) {\n    style['position'] = 'relative'\n  }\n  return `${objToStyle(style)}`\n})\n\nconst containerStyle = computed(() => {\n  const style: CSSProperties = {\n    position: stickyState.position as 'static' | 'relative' | 'absolute' | 'sticky' | 'fixed',\n    top: addUnit(stickyState.top)\n  }\n  return objToStyle(style)\n})\n\nconst innerOffsetTop = computed(() => {\n  let top: number = 0\n\n\n\n\n\n\n  return top + props.offsetTop\n})\n\n/**\n * 清除对当前组件的监听\n */\nfunction clearObserver() {\n  while (observerList.value.length !== 0) {\n    observerList.value.pop()!.disconnect()\n  }\n}\n/**\n * 添加对当前组件的监听\n */\nfunction createObserver() {\n  const observer = uni.createIntersectionObserver(proxy, { thresholds: [0, 0.5] })\n  observerList.value.push(observer)\n  return observer\n}\n/**\n *  当前内容高度发生变化时重置监听\n */\nasync function handleResize(detail: any) {\n  stickyState.width = detail.width\n  stickyState.height = detail.height\n  await pause()\n  observerContentScroll()\n  if (!stickyBox || !stickyBox.observerForChild) return\n  stickyBox.observerForChild(proxy)\n}\n/**\n *  监听吸顶元素滚动事件\n */\nfunction observerContentScroll() {\n  if (stickyState.height === 0 && stickyState.width === 0) return\n  const offset = innerOffsetTop.value + stickyState.height\n  clearObserver()\n  createObserver()\n    .relativeToViewport({\n      top: -offset\n    })\n    .observe(`#${styckyId.value}`, (result) => {\n      handleRelativeTo(result)\n    })\n  getRect(`#${styckyId.value}`, false, proxy).then((res) => {\n\n\n\n\n    if (Number(res.bottom) <= offset) handleRelativeTo({ boundingClientRect: res })\n  })\n}\n/**\n * @description 根据位置进行吸顶\n */\nfunction handleRelativeTo({ boundingClientRect }: any) {\n  // sticky 高度大于或等于 wd-sticky-box，使用 wd-sticky-box 无任何意义\n  if (stickyBox && stickyBox.boxStyle && stickyState.height >= stickyBox.boxStyle.height) {\n    stickyState.position = 'absolute'\n    stickyState.top = 0\n    return\n  }\n\n  let isStycky = boundingClientRect.top <= innerOffsetTop.value\n\n\n\n\n  if (isStycky) {\n    stickyState.state = 'sticky'\n    stickyState.boxLeaved = false\n    stickyState.position = 'fixed'\n    stickyState.top = innerOffsetTop.value\n  } else {\n    stickyState.state = 'normal'\n    stickyState.boxLeaved = false\n    stickyState.position = 'absolute'\n    stickyState.top = 0\n  }\n}\n\n/**\n * 设置位置\n * @param setboxLeaved\n * @param setPosition\n * @param setTop\n */\nfunction setPosition(boxLeaved: boolean, position: string, top: number) {\n  stickyState.boxLeaved = boxLeaved\n  stickyState.position = position\n  stickyState.top = top\n}\n\ndefineExpose({\n  setPosition,\n  stickyState,\n  offsetTop: props.offsetTop\n})\n</script>\n<style lang=\"scss\" scoped>\n@import './index.scss';\n</style>\n","import Component from '/Users/jing/Code/mini/vehicle-info/uni_modules/wot-design-uni/components/wd-sticky/wd-sticky.vue'\nwx.createComponent(Component)"],"names":["wdResize","__default__","props","__props","styckyId","ref","uuid","observerList","stickyState","reactive","stickyBox","useParent","STICKY_BOX_KEY","proxy","getCurrentInstance","rootStyle","computed","style","addUnit","objToStyle","stickyStyle","containerStyle","innerOffsetTop","clearObserver","createObserver","observer","uni","handleResize","detail","pause","observerContentScroll","offset","result","handleRelativeTo","getRect","res","boundingClientRect","setPosition","boxLeaved","position","top","__expose","Component"],"mappings":"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"}
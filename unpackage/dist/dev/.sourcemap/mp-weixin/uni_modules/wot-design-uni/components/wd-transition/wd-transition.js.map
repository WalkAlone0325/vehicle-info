{"version":3,"file":"wd-transition.js","sources":["uni_modules/wot-design-uni/components/wd-transition/wd-transition.vue","/Users/jing/Code/mini/vehicle-info/uni_modules/wot-design-uni/components/wd-transition/wd-transition.vue?type=component"],"sourcesContent":["<template>\n  <view v-if=\"!lazyRender || inited\" :class=\"rootClass\" :style=\"style\" @transitionend=\"onTransitionEnd\" @click=\"handleClick\">\n    <slot />\n  </view>\n</template>\n\n<script lang=\"ts\">\nexport default {\n  name: 'wd-transition',\n  options: {\n    addGlobalClass: true,\n    virtualHost: true,\n    styleIsolation: 'shared'\n  }\n}\n</script>\n\n<script lang=\"ts\" setup>\nimport { computed, onBeforeMount, ref, watch } from 'vue'\nimport { isObj, isPromise, pause } from '../common/util'\nimport { transitionProps, type TransitionName } from './types'\nimport { AbortablePromise } from '../common/AbortablePromise'\n\nconst getClassNames = (name?: TransitionName | TransitionName[]) => {\n  let enter: string = `${props.enterClass} ${props.enterActiveClass}`\n  let enterTo: string = `${props.enterToClass} ${props.enterActiveClass}`\n  let leave: string = `${props.leaveClass} ${props.leaveActiveClass}`\n  let leaveTo: string = `${props.leaveToClass} ${props.leaveActiveClass}`\n\n  if (Array.isArray(name)) {\n    for (let index = 0; index < name.length; index++) {\n      enter = `wd-${name[index]}-enter wd-${name[index]}-enter-active ${enter}`\n      enterTo = `wd-${name[index]}-enter-to wd-${name[index]}-enter-active ${enterTo}`\n      leave = `wd-${name[index]}-leave wd-${name[index]}-leave-active ${leave}`\n      leaveTo = `wd-${name[index]}-leave-to wd-${name[index]}-leave-active ${leaveTo}`\n    }\n  } else if (name) {\n    enter = `wd-${name}-enter wd-${name}-enter-active ${enter}`\n    enterTo = `wd-${name}-enter-to wd-${name}-enter-active ${enterTo}`\n    leave = `wd-${name}-leave wd-${name}-leave-active ${leave}`\n    leaveTo = `wd-${name}-leave-to wd-${name}-leave-active ${leaveTo}`\n  }\n  return {\n    enter: enter,\n    'enter-to': enterTo,\n    leave: leave,\n    'leave-to': leaveTo\n  }\n}\n\nconst props = defineProps(transitionProps)\nconst emit = defineEmits(['click', 'before-enter', 'enter', 'before-leave', 'leave', 'after-leave', 'after-enter'])\n\n// 初始化是否完成\nconst inited = ref<boolean>(false)\n// 是否显示\nconst display = ref<boolean>(false)\n// 当前动画状态\nconst status = ref<string>('')\n// 动画是否结束\nconst transitionEnded = ref<boolean>(false)\n// 动画持续时间\nconst currentDuration = ref<number>(300)\n// 类名\nconst classes = ref<string>('')\n// 用于控制enter和leave的顺序执行\nconst enterPromise = ref<AbortablePromise<void> | null>(null)\n\n// 动画进入的生命周期\nconst enterLifeCyclePromises = ref<AbortablePromise<unknown> | null>(null)\n\n// 动画离开的生命周期\nconst leaveLifeCyclePromises = ref<AbortablePromise<unknown> | null>(null)\n\nconst style = computed(() => {\n  return `-webkit-transition-duration:${currentDuration.value}ms;transition-duration:${currentDuration.value}ms;${\n    display.value || !props.destroy ? '' : 'display: none;'\n  }${props.customStyle}`\n})\n\nconst rootClass = computed(() => {\n  return `wd-transition ${props.customClass}  ${classes.value}`\n})\n\nonBeforeMount(() => {\n  if (props.show) {\n    enter()\n  }\n})\n\nwatch(\n  () => props.show,\n  (newVal) => {\n    handleShow(newVal)\n  },\n  { deep: true }\n)\n\nfunction handleClick() {\n  emit('click')\n}\n\nfunction handleShow(value: boolean) {\n  if (value) {\n    handleAbortPromise()\n    enter()\n  } else {\n    leave()\n  }\n}\n/**\n * 取消所有的promise\n */\nfunction handleAbortPromise() {\n  isPromise(enterPromise.value) && enterPromise.value.abort()\n  isPromise(enterLifeCyclePromises.value) && enterLifeCyclePromises.value.abort()\n  isPromise(leaveLifeCyclePromises.value) && leaveLifeCyclePromises.value.abort()\n  enterPromise.value = null\n  enterLifeCyclePromises.value = null\n  leaveLifeCyclePromises.value = null\n}\n\nfunction enter() {\n  enterPromise.value = new AbortablePromise(async (resolve) => {\n    try {\n      const classNames = getClassNames(props.name)\n      const duration = isObj(props.duration) ? (props.duration as any).enter : props.duration\n      status.value = 'enter'\n      emit('before-enter')\n      enterLifeCyclePromises.value = pause()\n      await enterLifeCyclePromises.value\n      emit('enter')\n      classes.value = classNames.enter\n      currentDuration.value = duration\n      enterLifeCyclePromises.value = pause()\n      await enterLifeCyclePromises.value\n      inited.value = true\n      display.value = true\n      enterLifeCyclePromises.value = pause()\n      await enterLifeCyclePromises.value\n      enterLifeCyclePromises.value = null\n      transitionEnded.value = false\n      classes.value = classNames['enter-to']\n      resolve()\n    } catch (error) {\n      /**\n       *\n       */\n    }\n  })\n}\nasync function leave() {\n  if (!enterPromise.value) {\n    transitionEnded.value = false\n    return onTransitionEnd()\n  }\n  try {\n    await enterPromise.value\n    if (!display.value) return\n    const classNames = getClassNames(props.name)\n    const duration = isObj(props.duration) ? (props.duration as any).leave : props.duration\n    status.value = 'leave'\n    emit('before-leave')\n    currentDuration.value = duration\n    leaveLifeCyclePromises.value = pause()\n    await leaveLifeCyclePromises.value\n    emit('leave')\n    classes.value = classNames.leave\n    leaveLifeCyclePromises.value = pause()\n    await leaveLifeCyclePromises.value\n    transitionEnded.value = false\n    classes.value = classNames['leave-to']\n    leaveLifeCyclePromises.value = setPromise(currentDuration.value)\n    await leaveLifeCyclePromises.value\n    leaveLifeCyclePromises.value = null\n    onTransitionEnd()\n    enterPromise.value = null\n  } catch (error) {\n    /**\n     *\n     */\n  }\n}\n\n/**\n * 定时器promise化\n * @param duration 持续时间ms\n */\nfunction setPromise(duration: number) {\n  return new AbortablePromise<void>((resolve) => {\n    const timer = setTimeout(() => {\n      clearTimeout(timer)\n      resolve()\n    }, duration)\n  })\n}\nfunction onTransitionEnd() {\n  if (transitionEnded.value) return\n\n  transitionEnded.value = true\n  if (status.value === 'leave') {\n    // 离开后触发\n    emit('after-leave')\n  } else if (status.value === 'enter') {\n    // 进入后触发\n    emit('after-enter')\n  }\n\n  if (!props.show && display.value) {\n    display.value = false\n  }\n}\n</script>\n<style lang=\"scss\" scoped>\n@import './index.scss';\n</style>\n","import Component from '/Users/jing/Code/mini/vehicle-info/uni_modules/wot-design-uni/components/wd-transition/wd-transition.vue'\nwx.createComponent(Component)"],"names":["__default__","getClassNames","name","enter","props","enterTo","leave","leaveTo","index","__props","emit","__emit","inited","ref","display","status","transitionEnded","currentDuration","classes","enterPromise","enterLifeCyclePromises","leaveLifeCyclePromises","style","computed","rootClass","onBeforeMount","watch","newVal","handleShow","handleClick","value","handleAbortPromise","isPromise","AbortablePromise","resolve","classNames","duration","isObj","pause","onTransitionEnd","setPromise","timer","Component"],"mappings":"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"}
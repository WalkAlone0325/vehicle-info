{"version":3,"file":"wd-form.js","sources":["uni_modules/wot-design-uni/components/wd-form/wd-form.vue","/Users/jing/Code/mini/vehicle-info/uni_modules/wot-design-uni/components/wd-form/wd-form.vue?type=component"],"sourcesContent":["<template>\n  <view :class=\"`wd-form ${customClass}`\" :style=\"customStyle\">\n    <slot></slot>\n    <wd-toast v-if=\"props.errorType === 'toast'\" selector=\"wd-form-toast\" />\n  </view>\n</template>\n\n<script lang=\"ts\">\nexport default {\n  name: 'wd-form',\n  options: {\n    addGlobalClass: true,\n    virtualHost: true,\n    styleIsolation: 'shared'\n  }\n}\n</script>\n\n<script lang=\"ts\" setup>\nimport wdToast from '../wd-toast/wd-toast.vue'\nimport { reactive, watch } from 'vue'\nimport { deepClone, getPropByPath, isArray, isDef, isPromise, isString } from '../common/util'\nimport { useChildren } from '../composables/useChildren'\nimport { useToast } from '../wd-toast'\nimport { type FormRules, FORM_KEY, type ErrorMessage, formProps, type FormExpose } from './types'\n\nconst { show: showToast } = useToast('wd-form-toast')\nconst props = defineProps(formProps)\n\nconst { children, linkChildren } = useChildren(FORM_KEY)\nlet errorMessages = reactive<Record<string, string>>({})\n\nlinkChildren({ props, errorMessages })\n\nwatch(\n  () => props.model,\n  () => {\n    if (props.resetOnChange) {\n      clearMessage()\n    }\n  },\n  { immediate: true, deep: true }\n)\n\n/**\n * 表单校验\n * @param prop 指定校验字段或字段数组\n */\nasync function validate(prop?: string | string[]): Promise<{ valid: boolean; errors: ErrorMessage[] }> {\n  const errors: ErrorMessage[] = []\n  let valid: boolean = true\n  const promises: Promise<void>[] = []\n  const formRules: FormRules = getMergeRules()\n  const propsToValidate = isArray(prop) ? prop : isDef(prop) ? [prop] : []\n  const rulesToValidate: FormRules =\n    propsToValidate.length > 0\n      ? propsToValidate.reduce((acc, key) => {\n          if (formRules[key]) {\n            acc[key] = formRules[key]\n          }\n          return acc\n        }, {} as FormRules)\n      : formRules\n\n  for (const propName in rulesToValidate) {\n    const rules = rulesToValidate[propName]\n    const value = getPropByPath(props.model, propName)\n\n    if (rules && rules.length > 0) {\n      for (const rule of rules) {\n        if (rule.required && (!isDef(value) || value === '')) {\n          errors.push({\n            prop: propName,\n            message: rule.message\n          })\n          valid = false\n          break\n        }\n        if (rule.pattern && !rule.pattern.test(value)) {\n          errors.push({\n            prop: propName,\n            message: rule.message\n          })\n          valid = false\n          break\n        }\n        const { validator, ...ruleWithoutValidator } = rule\n        if (validator) {\n          const result = validator(value, ruleWithoutValidator)\n          if (isPromise(result)) {\n            promises.push(\n              result\n                .then((res) => {\n                  if (typeof res === 'string') {\n                    errors.push({\n                      prop: propName,\n                      message: res\n                    })\n                    valid = false\n                  } else if (typeof res === 'boolean' && !res) {\n                    errors.push({\n                      prop: propName,\n                      message: rule.message\n                    })\n                    valid = false\n                  }\n                })\n                .catch((error?: string | Error) => {\n                  const message = isDef(error) ? (isString(error) ? error : error.message || rule.message) : rule.message\n                  errors.push({ prop: propName, message })\n                  valid = false\n                })\n            )\n          } else {\n            if (!result) {\n              errors.push({\n                prop: propName,\n                message: rule.message\n              })\n              valid = false\n            }\n          }\n        }\n      }\n    }\n  }\n\n  await Promise.all(promises)\n\n  showMessage(errors)\n\n  if (valid) {\n    if (propsToValidate.length) {\n      propsToValidate.forEach(clearMessage)\n    } else {\n      clearMessage()\n    }\n  }\n\n  return {\n    valid,\n    errors\n  }\n}\n\n// 合并子组件的rules到父组件的rules\nfunction getMergeRules() {\n  const mergedRules: FormRules = deepClone(props.rules)\n  const childrenProps = children.map((child) => child.prop)\n\n  // 过滤掉在 children 中不存在对应子组件的规则\n  Object.keys(mergedRules).forEach((key) => {\n    if (!childrenProps.includes(key)) {\n      delete mergedRules[key]\n    }\n  })\n\n  children.forEach((item) => {\n    if (isDef(item.prop) && isDef(item.rules) && item.rules.length) {\n      if (mergedRules[item.prop]) {\n        mergedRules[item.prop] = [...mergedRules[item.prop], ...item.rules]\n      } else {\n        mergedRules[item.prop] = item.rules\n      }\n    }\n  })\n  return mergedRules\n}\n\nfunction showMessage(errors: ErrorMessage[]) {\n  const childrenProps = children.map((e) => e.prop).filter(Boolean)\n  const messages = errors.filter((error) => error.message && childrenProps.includes(error.prop))\n  if (messages.length) {\n    messages.sort((a, b) => {\n      return childrenProps.indexOf(a.prop) - childrenProps.indexOf(b.prop)\n    })\n    if (props.errorType === 'toast') {\n      showToast(messages[0].message)\n    } else if (props.errorType === 'message') {\n      messages.forEach((error) => {\n        errorMessages[error.prop] = error.message\n      })\n    }\n  }\n}\n\nfunction clearMessage(prop?: string) {\n  if (prop) {\n    errorMessages[prop] = ''\n  } else {\n    Object.keys(errorMessages).forEach((key) => {\n      errorMessages[key] = ''\n    })\n  }\n}\n\n/**\n * 重置表单项的验证提示\n */\nfunction reset() {\n  clearMessage()\n}\n\ndefineExpose<FormExpose>({ validate, reset })\n</script>\n\n<style lang=\"scss\" scoped>\n@import './index.scss';\n</style>\n","import Component from '/Users/jing/Code/mini/vehicle-info/uni_modules/wot-design-uni/components/wd-form/wd-form.vue'\nwx.createComponent(Component)"],"names":["wdToast","__default__","showToast","useToast","props","__props","children","linkChildren","useChildren","FORM_KEY","errorMessages","reactive","watch","clearMessage","validate","prop","errors","valid","promises","formRules","getMergeRules","propsToValidate","isArray","isDef","rulesToValidate","acc","key","propName","rules","value","getPropByPath","rule","validator","ruleWithoutValidator","result","isPromise","res","error","message","isString","showMessage","mergedRules","deepClone","childrenProps","child","item","e","messages","a","b","reset","__expose","Component"],"mappings":"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"}
{"version":3,"file":"useUpload.js","sources":["uni_modules/wot-design-uni/components/composables/useUpload.ts"],"sourcesContent":["import { isArray, isDef, isFunction } from '../common/util'\nimport type { ChooseFile, ChooseFileOption, UploadFileItem, UploadMethod, UploadStatusType } from '../wd-upload/types'\n\nexport const UPLOAD_STATUS: Record<string, UploadStatusType> = {\n  PENDING: 'pending',\n  LOADING: 'loading',\n  SUCCESS: 'success',\n  FAIL: 'fail'\n}\n\nexport interface UseUploadReturn {\n  // 开始上传文件\n  startUpload: (file: UploadFileItem, options: UseUploadOptions) => UniApp.UploadTask | void | Promise<void>\n  // 中断上传\n  abort: (task?: UniApp.UploadTask) => void\n  // 上传状态常量\n  UPLOAD_STATUS: Record<string, UploadStatusType>\n  // 选择文件\n  chooseFile: (options: ChooseFileOption) => Promise<ChooseFile[]>\n}\n\nexport interface UseUploadOptions {\n  // 上传地址\n  action: string\n  // 请求头\n  header?: Record<string, any>\n  // 文件对应的 key\n  name?: string\n  // 其它表单数据\n  formData?: Record<string, any>\n  // 文件类型 仅支付宝支持且在支付宝平台必填\n  fileType?: 'image' | 'video' | 'audio'\n  // 成功状态码\n  statusCode?: number\n  // 文件状态的key\n  statusKey?: string\n  // 自定义上传方法\n  uploadMethod?: UploadMethod\n  // 上传成功回调\n  onSuccess?: (res: UniApp.UploadFileSuccessCallbackResult, file: UploadFileItem, formData: Record<string, any>) => void\n  // 上传失败回调\n  onError?: (res: UniApp.GeneralCallbackResult, file: UploadFileItem, formData: Record<string, any>) => void\n  // 上传进度回调\n  onProgress?: (res: UniApp.OnProgressUpdateResult, file: UploadFileItem) => void\n  // 是否自动中断之前的上传任务\n  abortPrevious?: boolean\n  // 根据文件拓展名过滤(H5支持全部类型过滤,微信小程序支持all和file时过滤,其余平台不支持)\n  extension?: string[]\n}\n\nexport function useUpload(): UseUploadReturn {\n  let currentTask: UniApp.UploadTask | null = null\n\n  // 中断上传\n  const abort = (task?: UniApp.UploadTask) => {\n    if (task) {\n      task.abort()\n    } else if (currentTask) {\n      currentTask.abort()\n      currentTask = null\n    }\n  }\n\n  /**\n   * 默认上传方法\n   */\n  const defaultUpload: UploadMethod = (file, formData, options) => {\n    // 如果配置了自动中断,则中断之前的上传任务\n    if (options.abortPrevious) {\n      abort()\n    }\n\n    const uploadTask = uni.uploadFile({\n      url: options.action,\n      header: options.header,\n      name: options.name,\n      fileName: options.name,\n      fileType: options.fileType,\n      formData,\n      filePath: file.url,\n      success(res) {\n        if (res.statusCode === options.statusCode) {\n          // 上传成功\n          options.onSuccess(res, file, formData)\n        } else {\n          // 上传失败\n          options.onError({ ...res, errMsg: res.errMsg || '' }, file, formData)\n        }\n      },\n      fail(err) {\n        // 上传失败\n        options.onError(err, file, formData)\n      }\n    })\n\n    currentTask = uploadTask\n\n    // 获取当前文件加载的百分比\n    uploadTask.onProgressUpdate((res) => {\n      options.onProgress(res, file)\n    })\n\n    // 返回上传任务实例,让外部可以控制上传过程\n    return uploadTask\n  }\n\n  /**\n   * 开始上传文件\n   */\n  const startUpload = (file: UploadFileItem, options: UseUploadOptions) => {\n    const {\n      uploadMethod,\n      formData = {},\n      action,\n      name = 'file',\n      header = {},\n      fileType = 'image',\n      statusCode = 200,\n      statusKey = 'status',\n      abortPrevious = false\n    } = options\n\n    // 设置上传中状态\n    file[statusKey] = UPLOAD_STATUS.LOADING\n\n    const uploadOptions = {\n      action,\n      header,\n      name,\n      fileName: name,\n      fileType,\n      statusCode,\n      abortPrevious,\n      onSuccess: (res: UniApp.UploadFileSuccessCallbackResult, file: UploadFileItem, formData: Record<string, any>) => {\n        // 更新文件状态\n        file[statusKey] = UPLOAD_STATUS.SUCCESS\n        currentTask = null\n        options.onSuccess?.(res, file, formData)\n      },\n      onError: (error: UniApp.GeneralCallbackResult, file: UploadFileItem, formData: Record<string, any>) => {\n        // 更新文件状态和错误信息\n        file[statusKey] = UPLOAD_STATUS.FAIL\n        file.error = error.errMsg\n        currentTask = null\n        options.onError?.(error, file, formData)\n      },\n      onProgress: (res: UniApp.OnProgressUpdateResult, file: UploadFileItem) => {\n        // 更新上传进度\n        file.percent = res.progress\n        options.onProgress?.(res, file)\n      }\n    }\n\n    // 返回上传任务实例,支持外部获取uploadTask进行操作\n    if (isFunction(uploadMethod)) {\n      return uploadMethod(file, formData, uploadOptions)\n    } else {\n      return defaultUpload(file, formData, uploadOptions)\n    }\n  }\n\n  /**\n   * 格式化图片信息\n   */\n  function formatImage(res: UniApp.ChooseImageSuccessCallbackResult): ChooseFile[] {\n    // #ifdef MP-DINGTALK\n    // 钉钉文件在files中\n    res.tempFiles = isDef((res as any).files) ? (res as any).files : res.tempFiles\n    // #endif\n    if (isArray(res.tempFiles)) {\n      return res.tempFiles.map((item: any) => ({\n        path: item.path || '',\n        name: item.name || '',\n        size: item.size,\n        type: 'image',\n        thumb: item.path || ''\n      }))\n    }\n    return [\n      {\n        path: (res.tempFiles as any).path || '',\n        name: (res.tempFiles as any).name || '',\n        size: (res.tempFiles as any).size,\n        type: 'image',\n        thumb: (res.tempFiles as any).path || ''\n      }\n    ]\n  }\n\n  /**\n   * 格式化视频信息\n   */\n  function formatVideo(res: UniApp.ChooseVideoSuccess): ChooseFile[] {\n    return [\n      {\n        path: res.tempFilePath || (res as any).filePath || '',\n        name: res.name || '',\n        size: res.size,\n        type: 'video',\n        thumb: (res as any).thumbTempFilePath || '',\n        duration: res.duration\n      }\n    ]\n  }\n\n  /**\n   * 格式化媒体信息\n   */\n  function formatMedia(res: UniApp.ChooseMediaSuccessCallbackResult): ChooseFile[] {\n    return res.tempFiles.map((item) => ({\n      type: item.fileType,\n      path: item.tempFilePath,\n      thumb: item.fileType === 'video' ? item.thumbTempFilePath : item.tempFilePath,\n      size: item.size,\n      duration: item.duration\n    }))\n  }\n\n  /**\n   * 选择文件\n   */\n  function chooseFile({\n    multiple,\n    sizeType,\n    sourceType,\n    maxCount,\n    accept,\n    compressed,\n    maxDuration,\n    camera,\n    extension\n  }: ChooseFileOption): Promise<ChooseFile[]> {\n    return new Promise((resolve, reject) => {\n      switch (accept) {\n        case 'image':\n          uni.chooseImage({\n            count: multiple ? Math.min(maxCount || 9, 9) : 1, // 默认9,最大9\n            sizeType,\n            sourceType,\n            // #ifdef H5\n            extension,\n            // #endif\n            success: (res) => resolve(formatImage(res)),\n            fail: reject\n          })\n          break\n        case 'video':\n          uni.chooseVideo({\n            sourceType,\n            compressed,\n            maxDuration,\n            camera,\n            // #ifdef H5\n            extension,\n            // #endif\n            success: (res) => resolve(formatVideo(res)),\n            fail: reject\n          })\n          break\n        // #ifdef MP-WEIXIN\n        case 'media':\n          uni.chooseMedia({\n            count: multiple ? Math.min(maxCount || 9, 9) : 1, // 默认9,最大9\n            sourceType,\n            sizeType,\n            camera,\n            maxDuration,\n            success: (res) => resolve(formatMedia(res)),\n            fail: reject\n          })\n          break\n        case 'file':\n          uni.chooseMessageFile({\n            count: multiple ? Math.min(maxCount || 100, 100) : 1, // 默认100,最大100\n            type: accept,\n            extension,\n            success: (res) => resolve(res.tempFiles),\n            fail: reject\n          })\n          break\n        // #endif\n        case 'all':\n          // #ifdef H5\n          uni.chooseFile({\n            count: multiple ? Math.min(maxCount || 100, 100) : 1, // 默认100,最大100\n            type: accept,\n            extension,\n            success: (res) => resolve(res.tempFiles as ChooseFile[]),\n            fail: reject\n          })\n          // #endif\n          // #ifdef MP-WEIXIN\n          uni.chooseMessageFile({\n            count: multiple ? Math.min(maxCount || 100, 100) : 1, // 默认100,最大100\n            type: accept,\n            extension,\n            success: (res) => resolve(res.tempFiles),\n            fail: reject\n          })\n          // #endif\n\n          break\n        default:\n          // 默认选择图片\n          uni.chooseImage({\n            count: multiple ? Math.min(maxCount || 9, 9) : 1, // 默认9,最大9\n            sizeType,\n            sourceType,\n            // #ifdef H5\n            extension,\n            // #endif\n            success: (res) => resolve(formatImage(res)),\n            fail: reject\n          })\n          break\n      }\n    })\n  }\n\n  return {\n    startUpload,\n    abort,\n    UPLOAD_STATUS,\n    chooseFile\n  }\n}\n"],"names":["UPLOAD_STATUS","useUpload","currentTask","abort","task","defaultUpload","file","formData","options","uploadTask","uni","res","err","startUpload","uploadMethod","action","name","header","fileType","statusCode","statusKey","abortPrevious","uploadOptions","_a","error","isFunction","formatImage","isArray","item","formatVideo","formatMedia","chooseFile","multiple","sizeType","sourceType","maxCount","accept","compressed","maxDuration","camera","extension","resolve","reject"],"mappings":"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"}
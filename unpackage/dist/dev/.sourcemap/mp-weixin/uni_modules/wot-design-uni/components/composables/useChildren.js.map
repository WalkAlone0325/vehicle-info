{"version":3,"file":"useChildren.js","sources":["uni_modules/wot-design-uni/components/composables/useChildren.ts"],"sourcesContent":["import {\n  provide,\n  reactive,\n  getCurrentInstance,\n  type VNode,\n  type InjectionKey,\n  type VNodeNormalizedChildren,\n  type ComponentPublicInstance,\n  type ComponentInternalInstance\n} from 'vue'\n\n// 小程序端不支持从vue导出的isVNode方法，参考uni-mp-vue的实现\nfunction isVNode(value: any): value is VNode {\n  return value ? value.__v_isVNode === true : false\n}\n\nexport function flattenVNodes(children: VNodeNormalizedChildren) {\n  const result: VNode[] = []\n\n  const traverse = (children: VNodeNormalizedChildren) => {\n    if (Array.isArray(children)) {\n      children.forEach((child) => {\n        if (isVNode(child)) {\n          result.push(child)\n\n          if (child.component?.subTree) {\n            result.push(child.component.subTree)\n            traverse(child.component.subTree.children)\n          }\n\n          if (child.children) {\n            traverse(child.children)\n          }\n        }\n      })\n    }\n  }\n\n  traverse(children)\n\n  return result\n}\n\nconst findVNodeIndex = (vnodes: VNode[], vnode: VNode) => {\n  const index = vnodes.indexOf(vnode)\n  if (index === -1) {\n    return vnodes.findIndex((item) => vnode.key !== undefined && vnode.key !== null && item.type === vnode.type && item.key === vnode.key)\n  }\n  return index\n}\n\n// sort children instances by vnodes order\nexport function sortChildren(\n  parent: ComponentInternalInstance,\n  publicChildren: ComponentPublicInstance[],\n  internalChildren: ComponentInternalInstance[]\n) {\n  const vnodes = parent && parent.subTree && parent.subTree.children ? flattenVNodes(parent.subTree.children) : []\n\n  internalChildren.sort((a, b) => findVNodeIndex(vnodes, a.vnode) - findVNodeIndex(vnodes, b.vnode))\n\n  const orderedPublicChildren = internalChildren.map((item) => item.proxy!)\n\n  publicChildren.sort((a, b) => {\n    const indexA = orderedPublicChildren.indexOf(a)\n    const indexB = orderedPublicChildren.indexOf(b)\n    return indexA - indexB\n  })\n}\n\nexport function useChildren<\n  // eslint-disable-next-line\n  Child extends ComponentPublicInstance = ComponentPublicInstance<{}, any>,\n  ProvideValue = never\n>(key: InjectionKey<ProvideValue>) {\n  const publicChildren: Child[] = reactive([])\n  const internalChildren: ComponentInternalInstance[] = reactive([])\n  const parent = getCurrentInstance()!\n\n  const linkChildren = (value?: ProvideValue) => {\n    const link = (child: ComponentInternalInstance) => {\n      if (child.proxy) {\n        internalChildren.push(child)\n        publicChildren.push(child.proxy as Child)\n        sortChildren(parent, publicChildren, internalChildren)\n      }\n    }\n\n    const unlink = (child: ComponentInternalInstance) => {\n      const index = internalChildren.indexOf(child)\n      publicChildren.splice(index, 1)\n      internalChildren.splice(index, 1)\n    }\n\n    provide(\n      key,\n      Object.assign(\n        {\n          link,\n          unlink,\n          children: publicChildren,\n          internalChildren\n        },\n        value\n      )\n    )\n  }\n\n  return {\n    children: publicChildren,\n    linkChildren\n  }\n}\n"],"names":["isVNode","value","flattenVNodes","children","result","traverse","child","_a","findVNodeIndex","vnodes","vnode","index","item","sortChildren","parent","publicChildren","internalChildren","a","b","orderedPublicChildren","indexA","indexB","useChildren","key","reactive","getCurrentInstance","link","unlink","provide"],"mappings":"6DAYA,SAASA,EAAQC,EAA4B,CACpC,OAAAA,EAAQA,EAAM,cAAgB,GAAO,EAC9C,CAEO,SAASC,EAAcC,EAAmC,CAC/D,MAAMC,EAAkB,CAAA,EAElBC,EAAYF,GAAsC,CAClD,MAAM,QAAQA,CAAQ,GACxBA,EAAS,QAASG,GAAU,OACtBN,EAAQM,CAAK,IACfF,EAAO,KAAKE,CAAK,GAEbC,EAAAD,EAAM,YAAN,MAAAC,EAAiB,UACZH,EAAA,KAAKE,EAAM,UAAU,OAAO,EAC1BD,EAAAC,EAAM,UAAU,QAAQ,QAAQ,GAGvCA,EAAM,UACRD,EAASC,EAAM,QAAQ,EAE3B,CACD,CACH,EAGF,OAAAD,EAASF,CAAQ,EAEVC,CACT,CAEA,MAAMI,EAAiB,CAACC,EAAiBC,IAAiB,CAClD,MAAAC,EAAQF,EAAO,QAAQC,CAAK,EAClC,OAAIC,IAAU,GACLF,EAAO,UAAWG,GAASF,EAAM,MAAQ,QAAaA,EAAM,MAAQ,MAAQE,EAAK,OAASF,EAAM,MAAQE,EAAK,MAAQF,EAAM,GAAG,EAEhIC,CACT,EAGgB,SAAAE,EACdC,EACAC,EACAC,EACA,CACA,MAAMP,EAASK,GAAUA,EAAO,SAAWA,EAAO,QAAQ,SAAWZ,EAAcY,EAAO,QAAQ,QAAQ,EAAI,CAAA,EAE9GE,EAAiB,KAAK,CAACC,EAAGC,IAAMV,EAAeC,EAAQQ,EAAE,KAAK,EAAIT,EAAeC,EAAQS,EAAE,KAAK,CAAC,EAEjG,MAAMC,EAAwBH,EAAiB,IAAKJ,GAASA,EAAK,KAAM,EAEzDG,EAAA,KAAK,CAACE,EAAGC,IAAM,CACtB,MAAAE,EAASD,EAAsB,QAAQF,CAAC,EACxCI,EAASF,EAAsB,QAAQD,CAAC,EAC9C,OAAOE,EAASC,CAAA,CACjB,CACH,CAEO,SAASC,EAIdC,EAAiC,CAC3B,MAAAR,EAA0BS,WAAS,CAAA,CAAE,EACrCR,EAAgDQ,WAAS,CAAA,CAAE,EAC3DV,EAASW,EAAAA,qBA+BR,MAAA,CACL,SAAUV,EACV,aA/BoBd,GAAyB,CACvC,MAAAyB,EAAQpB,GAAqC,CAC7CA,EAAM,QACRU,EAAiB,KAAKV,CAAK,EACZS,EAAA,KAAKT,EAAM,KAAc,EAC3BO,EAAAC,EAAQC,EAAgBC,CAAgB,EACvD,EAGIW,EAAUrB,GAAqC,CAC7C,MAAAK,EAAQK,EAAiB,QAAQV,CAAK,EAC7BS,EAAA,OAAOJ,EAAO,CAAC,EACbK,EAAA,OAAOL,EAAO,CAAC,CAAA,EAGlCiB,EAAA,QACEL,EACA,OAAO,OACL,CACE,KAAAG,EACA,OAAAC,EACA,SAAUZ,EACV,iBAAAC,CACF,EACAf,CACF,CAAA,CACF,CAKA,CAEJ"}